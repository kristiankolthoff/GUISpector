<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FitQuest Arcade</title>
<style>
:root {
    --bg: #0f172a;
    --bg-alt: #111b33;
    --card-bg: rgba(15, 23, 42, 0.85);
    --card-border: rgba(255, 255, 255, 0.08);
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --accent: #22d3ee;
    --success: #34d399;
    --warning: #facc15;
    --danger: #f87171;
    --text: #f8fafc;
    --text-subtle: #94a3b8;
    --shadow: 0 18px 35px rgba(15, 23, 42, 0.45);
    --radius: 16px;
    --transition: all 0.25s ease;
}
* {
    box-sizing: border-box;
}
html, body {
    margin: 0;
    padding: 0;
    background: radial-gradient(circle at top, #1e293b, #0f172a 55%);
    color: var(--text);
    font-family: "Segoe UI", Tahoma, sans-serif;
    min-height: 100vh;
}
body {
    display: flex;
    justify-content: center;
}
#app {
    width: 100%;
    max-width: 1400px;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}
header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 32px;
}
.brand {
    display: flex;
    align-items: center;
    gap: 14px;
}
.logo {
    width: 48px;
    height: 48px;
    border-radius: 14px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 18px;
    color: var(--bg);
    box-shadow: var(--shadow);
}
.brand-name {
    font-size: 28px;
    font-weight: 700;
    letter-spacing: 1px;
}
.user-summary {
    display: flex;
    align-items: center;
    gap: 24px;
    color: var(--text-subtle);
    font-size: 14px;
}
.user-summary strong {
    color: var(--text);
}
main {
    flex: 1;
    display: flex;
    padding: 0 24px 32px;
    gap: 24px;
}
.sidebar {
    width: 200px;
    padding: 20px;
    background: rgba(15, 23, 42, 0.6);
    border-radius: var(--radius);
    display: flex;
    flex-direction: column;
    gap: 10px;
    box-shadow: var(--shadow);
    position: sticky;
    top: 24px;
    height: fit-content;
}
.nav-btn {
    background: transparent;
    border: none;
    color: var(--text-subtle);
    padding: 12px 14px;
    border-radius: 12px;
    text-align: left;
    font-size: 15px;
    font-weight: 600;
    transition: var(--transition);
    cursor: pointer;
}
.nav-btn:hover {
    background: rgba(99,102,241,0.12);
    color: var(--text);
}
.nav-btn.active {
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: var(--bg);
    box-shadow: var(--shadow);
}
.view-container {
    flex: 1;
    display: flex;
}
.view {
    display: none;
    flex-direction: column;
    gap: 20px;
    width: 100%;
}
.view.active {
    display: flex;
}
.card {
    background: var(--card-bg);
    border-radius: var(--radius);
    border: 1px solid var(--card-border);
    padding: 22px 24px;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
}
.card::after {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at top right, rgba(99,102,241,0.15), transparent 60%);
    pointer-events: none;
}
.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
}
/* Dashboard */
.layout-grid {
    display: grid;
    gap: 20px;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
}
.level-card h2 {
    margin: 0 0 12px;
}
.level-progress {
    margin-top: 16px;
}
.progress-bar {
    background: rgba(148,163,184,0.2);
    height: 12px;
    border-radius: 999px;
    overflow: hidden;
    position: relative;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    width: 0;
    border-radius: inherit;
    transition: width 0.4s ease;
}
.progress-label {
    font-size: 13px;
    color: var(--text-subtle);
    margin-top: 8px;
}
.streak {
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.primary-btn, .ghost-btn {
    border: none;
    border-radius: 12px;
    padding: 12px 18px;
    font-weight: 600;
    cursor: pointer;
    font-size: 15px;
    transition: var(--transition);
}
.primary-btn {
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: var(--bg);
    box-shadow: var(--shadow);
}
.primary-btn:disabled {
    opacity: 0.4;
    cursor: default;
    box-shadow: none;
}
.primary-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 16px 30px rgba(99,102,241,0.35);
}
.ghost-btn {
    background: transparent;
    color: var(--text-subtle);
    border: 1px solid rgba(148,163,184,0.3);
}
.ghost-btn:hover {
    border-color: var(--accent);
    color: var(--text);
}
.filters {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.filter-btn {
    border: none;
    padding: 9px 16px;
    border-radius: 999px;
    background: rgba(99,102,241,0.14);
    color: var(--text-subtle);
    cursor: pointer;
    font-size: 14px;
    transition: var(--transition);
}
.filter-btn.active {
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: var(--bg);
}
.filter-btn:hover {
    color: var(--text);
}
.challenge-grid {
    display: grid;
    gap: 18px;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
}
.challenge-card {
    padding: 18px;
    border-radius: var(--radius);
    background: rgba(15, 23, 42, 0.75);
    border: 1px solid rgba(255,255,255,0.05);
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}
.challenge-card::before {
    content: attr(data-category);
    position: absolute;
    top: 16px;
    right: -20px;
    transform: rotate(35deg);
    font-size: 12px;
    letter-spacing: 1px;
    text-transform: uppercase;
    background: rgba(99,102,241,0.22);
    padding: 4px 24px;
    border-radius: 999px;
    color: rgba(241,245,249,0.7);
}
.challenge-card:hover {
    transform: translateY(-6px);
    border-color: rgba(99,102,241,0.5);
}
.challenge-name {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 6px;
}
.challenge-meta {
    display: flex;
    justify-content: space-between;
    color: var(--text-subtle);
    font-size: 13px;
}
.badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
}
.badge.easy { background: rgba(52,211,153,0.15); color: #34d399; }
.badge.medium { background: rgba(250,204,21,0.15); color: #facc15; }
.badge.hard { background: rgba(248,113,113,0.15); color: #f87171; }

.custom-section form,
.card form {
    display: grid;
    gap: 12px;
}
.custom-section input,
.custom-section select,
.card input,
.card select,
.card textarea,
.modal input,
.modal select,
.modal textarea {
    background: rgba(15, 23, 42, 0.65);
    border: 1px solid rgba(148,163,184,0.25);
    border-radius: 12px;
    padding: 10px 12px;
    color: var(--text);
    font-size: 14px;
    transition: border 0.2s ease;
}
.custom-section input:focus,
.custom-section select:focus,
.card input:focus,
.card select:focus,
.card textarea:focus,
.modal input:focus,
.modal select:focus,
.modal textarea:focus {
    border-color: var(--accent);
    outline: none;
}
.hint {
    font-size: 12px;
    color: var(--text-subtle);
    margin-top: 6px;
}

/* Active challenge view */
.active-wrapper {
    display: grid;
    gap: 24px;
}
.active-title {
    font-size: 22px;
    margin-bottom: 6px;
}
.active-meta {
    display: flex;
    gap: 20px;
    color: var(--text-subtle);
    font-size: 14px;
}
.active-progress {
    margin-top: 10px;
}
.counter-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 20px;
}
.counter-controls button {
    width: 48px;
    height: 48px;
    border-radius: 14px;
    border: none;
    font-size: 24px;
    font-weight: 700;
    cursor: pointer;
    color: var(--bg);
    background: linear-gradient(135deg, var(--primary), var(--accent));
    transition: var(--transition);
}
.counter-controls button:active {
    transform: scale(0.96);
}
.counter-value {
    font-size: 28px;
    font-weight: 700;
}
.active-actions {
    margin-top: 20px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}
.secondary-btn {
    border: none;
    border-radius: 12px;
    padding: 12px 18px;
    background: rgba(148,163,184,0.18);
    color: var(--text);
    cursor: pointer;
    transition: var(--transition);
}
.secondary-btn:hover {
    background: rgba(148,163,184,0.28);
}
.danger-btn {
    background: rgba(248,113,113,0.16);
    color: #f87171;
}
.danger-btn:hover {
    background: rgba(248,113,113,0.25);
}

/* Achievements */
.badge-grid {
    display: grid;
    gap: 16px;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
}
.badge-card {
    padding: 16px;
    border-radius: 16px;
    border: 1px solid rgba(148,163,184,0.15);
    background: rgba(15,23,42,0.65);
    position: relative;
    overflow: hidden;
}
.badge-card.earned {
    border-color: var(--accent);
    box-shadow: 0 16px 30px rgba(34,211,238,0.25);
}
.badge-card h4 {
    margin: 0 0 6px;
}

/* History */
.history-list, .feedback-list, .reminder-list, .group-list, .weekly-summary-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 12px;
}
.history-item, .feedback-item, .reminder-item, .group-item, .weekly-summary-item {
    padding: 14px 16px;
    border-radius: 14px;
    background: rgba(15,23,42,0.6);
    border: 1px solid rgba(148,163,184,0.1);
}
.history-item strong {
    display: inline-block;
    margin-bottom: 4px;
}
.meta-line {
    font-size: 12px;
    color: var(--text-subtle);
}

/* Leaderboard */
.leaderboard-list {
    list-style: none;
    margin: 12px 0 0;
    padding: 0;
    display: grid;
    gap: 10px;
}
.leaderboard-item {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 12px;
    align-items: center;
    padding: 12px 16px;
    border-radius: 14px;
    background: rgba(15,23,42,0.65);
    border: 1px solid rgba(148,163,184,0.12);
}
.rank {
    font-size: 18px;
    font-weight: 700;
    color: var(--accent);
}
.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: var(--bg);
}
.player-info {
    display: flex;
    flex-direction: column;
}
.player-name {
    font-weight: 600;
}
.player-score {
    font-size: 13px;
    color: var(--text-subtle);
}

/* Calendar */
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-top: 20px;
}
.calendar-day {
    text-align: center;
    padding: 12px 8px;
    border-radius: 12px;
    background: rgba(15,23,42,0.6);
    border: 1px solid rgba(148,163,184,0.1);
    min-height: 64px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-size: 13px;
    position: relative;
}
.calendar-day .date {
    font-weight: 600;
}
.calendar-day.today {
    border-color: var(--accent);
}
.calendar-day.rest {
    background: rgba(99,102,241,0.18);
    border-color: rgba(99,102,241,0.35);
}
.calendar-day.checkin {
    background: rgba(52,211,153,0.2);
    border-color: rgba(52,211,153,0.4);
}
.calendar-legend {
    margin-top: 18px;
    display: flex;
    gap: 16px;
    font-size: 12px;
    color: var(--text-subtle);
}
.legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
}
.legend-rest { background: rgba(99,102,241,0.6); }
.legend-checkin { background: rgba(52,211,153,0.6); }
.legend-empty { background: rgba(148,163,184,0.4); }

/* Store */
.store-grid {
    display: grid;
    gap: 16px;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
}
.store-item {
    padding: 18px;
    border-radius: 16px;
    background: rgba(15,23,42,0.7);
    border: 1px solid rgba(148,163,184,0.12);
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.store-cost {
    color: var(--accent);
    font-weight: 600;
}
.store-item button {
    margin-top: auto;
    background: rgba(148,163,184,0.18);
    border: none;
    color: var(--text-subtle);
    padding: 10px 14px;
    border-radius: 12px;
    cursor: not-allowed;
}

/* Avatar studio */
.avatar-studio {
    display: grid;
    gap: 20px;
    grid-template-columns: minmax(200px, 220px) 1fr;
}
.avatar-preview {
    width: 200px;
    height: 200px;
    border-radius: 32px;
    background: linear-gradient(135deg, rgba(99,102,241,0.35), rgba(34,211,238,0.25));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 80px;
    font-weight: 700;
    color: rgba(15,23,42,0.85);
    position: relative;
}
.avatar-preview::after {
    content: attr(data-accessory);
    position: absolute;
    font-size: 36px;
    top: 18px;
    right: 24px;
}
.avatar-options {
    display: grid;
    gap: 14px;
}
.option-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
.option-group button {
    border: none;
    padding: 8px 14px;
    border-radius: 12px;
    background: rgba(148,163,184,0.15);
    color: var(--text);
    cursor: pointer;
    transition: var(--transition);
}
.option-group button.active {
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: var(--bg);
}

/* Modals */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.65);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 24px;
    z-index: 60;
    backdrop-filter: blur(6px);
}
.modal.visible {
    display: flex;
}
.modal-content {
    background: rgba(15, 23, 42, 0.95);
    border-radius: 20px;
    padding: 28px;
    width: min(90vw, 480px);
    border: 1px solid rgba(148,163,184,0.2);
    box-shadow: var(--shadow);
    position: relative;
}
.modal-content h2 {
    margin-top: 0;
}
.close-modal {
    position: absolute;
    top: 18px;
    right: 18px;
    width: 32px;
    height: 32px;
    border-radius: 10px;
    border: none;
    background: rgba(148,163,184,0.18);
    color: var(--text);
    cursor: pointer;
    font-size: 16px;
}
#shareText {
    width: 100%;
    min-height: 160px;
    resize: vertical;
    border-radius: 16px;
}
.modal-footer {
    display: flex;
    gap: 10px;
    margin-top: 16px;
    justify-content: flex-end;
}
.copy-success {
    color: var(--success);
    font-size: 13px;
    margin-top: 8px;
}

/* Onboarding */
.onboarding {
    width: min(90vw, 420px);
}
.onboarding h2 {
    margin-bottom: 10px;
}
.onboarding p {
    color: var(--text-subtle);
    font-size: 14px;
}

/* Quick challenge */
.quick-challenge {
    display: grid;
    gap: 10px;
}
.quick-info {
    background: rgba(99,102,241,0.16);
    border-radius: 14px;
    padding: 12px 14px;
    font-size: 14px;
}
.quick-actions {
    display: flex;
    gap: 12px;
}

/* tutorial */
#tutorialOverlay {
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.72);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
    pointer-events: none;
}
#tutorialOverlay.active {
    display: flex;
}
#tutorialHighlight {
    position: absolute;
    border: 2px solid var(--accent);
    border-radius: 16px;
    box-shadow: 0 0 0 2000px rgba(15,23,42,0.72);
    transition: var(--transition);
    pointer-events: auto;
}
.tutorial-dialog {
    position: fixed;
    max-width: 360px;
    border-radius: 18px;
    padding: 22px 24px;
    background: rgba(15,23,42,0.95);
    border: 1px solid rgba(148,163,184,0.2);
    box-shadow: var(--shadow);
    bottom: 40px;
    right: 40px;
    pointer-events: auto;
}
.tutorial-dialog h3 {
    margin-top: 0;
}
.tutorial-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* Toast */
#toastContainer {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    display: grid;
    gap: 10px;
    z-index: 90;
}
.toast {
    background: rgba(15,23,42,0.92);
    border: 1px solid rgba(148,163,184,0.2);
    padding: 12px 18px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    animation: fadeIn 0.3s ease, fadeOut 0.3s ease 4s forwards;
}
.toast.success { border-color: rgba(52,211,153,0.35); }
.toast.info { border-color: rgba(99,102,241,0.35); }
.toast.warn { border-color: rgba(250,204,21,0.35); }

@keyframes fadeIn {
    from { opacity: 0; transform: translate(-50%, 20px); }
    to { opacity: 1; transform: translate(-50%, 0); }
}
@keyframes fadeOut {
    to { opacity: 0; transform: translate(-50%, 30px); }
}

textarea {
    font-family: inherit;
}

/* Responsive */
@media (max-width: 1024px) {
    main {
        flex-direction: column;
    }
    .sidebar {
        width: 100%;
        flex-direction: row;
        overflow-x: auto;
        position: static;
    }
    .nav-btn {
        flex: 1;
        text-align: center;
        white-space: nowrap;
    }
    .view-container {
        width: 100%;
    }
    .avatar-studio {
        grid-template-columns: 1fr;
        justify-items: center;
    }
}
@media (max-width: 720px) {
    header {
        flex-direction: column;
        gap: 16px;
    }
    .user-summary {
        flex-direction: column;
        align-items: flex-start;
    }
    .tutorial-dialog {
        left: 16px;
        right: 16px;
        bottom: 16px;
    }
}
</style>
</head>
<body>
<div id="app">
    <header>
        <div class="brand">
            <div class="logo">FQ</div>
            <div class="brand-name">FitQuest Arcade</div>
        </div>
        <div class="user-summary">
            <div><strong id="headerName">Welcome!</strong></div>
            <div>Focus: <strong id="headerGoal">Choose your goal</strong></div>
            <div>Level: <strong id="headerLevel">1</strong></div>
            <div>Total Points: <strong id="headerPoints">0</strong></div>
        </div>
    </header>
    <main>
        <nav class="sidebar">
            <button class="nav-btn active" data-view="dashboardView">Dashboard</button>
            <button class="nav-btn" data-view="activeView">Active Challenge</button>
            <button class="nav-btn" data-view="achievementsView">Achievements</button>
            <button class="nav-btn" data-view="historyView">History</button>
            <button class="nav-btn" data-view="leaderboardView">Leaderboard</button>
            <button class="nav-btn" data-view="calendarView">Calendar</button>
            <button class="nav-btn" data-view="groupsView">Group Play</button>
            <button class="nav-btn" data-view="storeView">Reward Store</button>
            <button class="nav-btn" data-view="remindersView">Reminders</button>
            <button class="nav-btn" data-view="settingsView">Settings</button>
        </nav>
        <div class="view-container">
            <section id="dashboardView" class="view active">
                <div class="layout-grid">
                    <div class="card level-card" id="levelCard">
                        <h2>Level Progress</h2>
                        <p id="levelDescription">Complete challenges to power up.</p>
                        <div class="level-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="levelProgressFill"></div>
                            </div>
                            <div class="progress-label" id="levelProgressLabel"></div>
                        </div>
                    </div>
                    <div class="card streak-card" id="streakCard">
                        <h2>Daily Streak</h2>
                        <div class="streak">
                            <div>
                                <div>Current Streak: <strong id="currentStreak">0</strong> days</div>
                                <div class="hint">Best streak: <span id="bestStreak">0</span> days</div>
                            </div>
                            <button class="primary-btn" id="checkInBtn">Check In Today</button>
                        </div>
                        <div class="hint" id="checkInStatus"></div>
                    </div>
                    <div class="card rest-card" id="restCard">
                        <h2>Plan a Rest Day</h2>
                        <form id="restDayForm">
                            <label for="restDayInput">Select date</label>
                            <input type="date" id="restDayInput" required>
                            <button type="submit" class="ghost-btn">Save Rest Day</button>
                        </form>
                        <div class="hint">Rest days protect your streak when you take a break.</div>
                    </div>
                    <div class="card quick-card">
                        <h2>Quick Challenge Generator</h2>
                        <div class="quick-challenge">
                            <div id="quickChallengeInfo" class="quick-info">Press generate to get a surprise mini challenge.</div>
                            <div class="quick-actions">
                                <button class="ghost-btn" id="quickChallengeBtn">Generate</button>
                                <button class="primary-btn" id="acceptQuickChallengeBtn" disabled>Accept</button>
                            </div>
                        </div>
                    </div>
                    <div class="card share-card">
                        <h2>Weekly Highlights</h2>
                        <p>Summarize your momentum and share it with friends.</p>
                        <button class="primary-btn" id="shareSummaryBtn">Create Shareable Summary</button>
                    </div>
                </div>
                <section class="card">
                    <div class="section-header">
                        <h2>Daily Challenges</h2>
                        <div class="filters" id="categoryFilters"></div>
                    </div>
                    <div class="challenge-grid" id="challengeGrid"></div>
                </section>
                <section class="card custom-section">
                    <h2>Custom Challenge Builder</h2>
                    <form id="customChallengeForm">
                        <div>
                            <label>Name</label>
                            <input type="text" id="customName" required>
                        </div>
                        <div>
                            <label>Category</label>
                            <select id="customCategory" required>
                                <option value="">Select a category</option>
                                <option value="Cardio">Cardio</option>
                                <option value="Strength">Strength</option>
                                <option value="Flexibility">Flexibility</option>
                                <option value="Core">Core</option>
                                <option value="Mindfulness">Mindfulness</option>
                            </select>
                        </div>
                        <div>
                            <label>Difficulty</label>
                            <select id="customDifficulty" required>
                                <option value="">Select difficulty</option>
                                <option value="Easy">Easy</option>
                                <option value="Medium">Medium</option>
                                <option value="Hard">Hard</option>
                            </select>
                        </div>
                        <div>
                            <label>Target Units</label>
                            <input type="number" min="1" id="customUnits" required>
                        </div>
                        <div>
                            <label>Unit Label (e.g. reps, minutes)</label>
                            <input type="text" id="customUnitLabel" required>
                        </div>
                        <div>
                            <label>Estimated Time</label>
                            <input type="text" id="customTime" placeholder="e.g. 25 minutes" required>
                        </div>
                        <div>
                            <label>Reward Points</label>
                            <input type="number" min="10" step="10" id="customReward" required>
                        </div>
                        <div>
                            <label>Objective</label>
                            <textarea id="customObjective" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="primary-btn">Add to Challenge Board</button>
                    </form>
                </section>
                <section class="card">
                    <h2>Scheduled Reminders</h2>
                    <ul class="reminder-list" id="reminderSummaryList"></ul>
                    <p class="hint">Timed alerts will light up challenges in a future update.</p>
                </section>
            </section>

            <section id="activeView" class="view">
                <div class="card">
                    <div id="activeContent"></div>
                </div>
            </section>

            <section id="achievementsView" class="view">
                <div class="card">
                    <h2>Achievement Badges</h2>
                    <p class="hint">Collect badges by hitting streaks, milestones, and total points.</p>
                    <div class="badge-grid" id="badgeGrid"></div>
                </div>
            </section>

            <section id="historyView" class="view">
                <div class="card">
                    <h2>Completed Challenges</h2>
                    <ul class="history-list" id="historyList"></ul>
                </div>
                <div class="card">
                    <h2>Weekly Summary Log</h2>
                    <ul class="weekly-summary-list" id="weeklySummaryList"></ul>
                </div>
            </section>

            <section id="leaderboardView" class="view">
                <div class="card">
                    <h2>Community Leaderboard</h2>
                    <p class="hint">Friends-only view is under construction.</p>
                    <ol class="leaderboard-list" id="leaderboardList"></ol>
                </div>
            </section>

            <section id="calendarView" class="view">
                <div class="card calendar-card">
                    <h2>Activity Calendar</h2>
                    <div id="calendarMonthLabel" class="hint"></div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                    <div class="calendar-legend">
                        <span><span class="legend-dot legend-checkin"></span>Daily Check-in</span>
                        <span><span class="legend-dot legend-rest"></span>Rest Day</span>
                        <span><span class="legend-dot legend-empty"></span>No Activity</span>
                    </div>
                </div>
            </section>

            <section id="groupsView" class="view">
                <div class="card">
                    <h2>Create a Group Challenge</h2>
                    <form id="groupChallengeForm">
                        <div>
                            <label>Challenge Name</label>
                            <input type="text" id="groupName" required>
                        </div>
                        <div>
                            <label>Shared Target Units</label>
                            <input type="number" min="1" id="groupTarget" required>
                        </div>
                        <div>
                            <label>Participant Slots</label>
                            <input type="number" min="1" max="20" id="groupSlots" required>
                        </div>
                        <button type="submit" class="primary-btn">Create Group Challenge</button>
                    </form>
                </div>
                <div class="card">
                    <h2>Team Journeys</h2>
                    <ul class="group-list" id="groupChallengeList"></ul>
                    <p class="hint">Live contribution tracking will arrive soon.</p>
                </div>
            </section>

            <section id="storeView" class="view">
                <div class="card">
                    <h2>Cosmetic Reward Store</h2>
                    <div class="store-grid" id="storeGrid"></div>
                    <p class="hint">Redemption and load-outs are planned for a future release.</p>
                </div>
            </section>

            <section id="remindersView" class="view">
                <div class="card">
                    <h2>Your Reminders</h2>
                    <p class="hint">Reminders list the challenges you plan to return to.</p>
                    <ul class="reminder-list" id="reminderList"></ul>
                </div>
            </section>

            <section id="settingsView" class="view">
                <div class="card">
                    <h2>Preferences</h2>
                    <label>
                        <input type="checkbox" id="soundToggle">
                        Enable interface sound effects
                    </label>
                    <p class="hint">Sound cues play when you log progress.</p>
                </div>
                <div class="card">
                    <h2>Avatar Studio</h2>
                    <div class="avatar-studio">
                        <div class="avatar-preview" id="avatarPreview" data-accessory="">👟</div>
                        <div class="avatar-options" id="avatarOptions">
                            <div>
                                <strong>Outfits</strong>
                                <div class="option-group" data-type="outfit">
                                    <button type="button" data-value="👟">Trail Runners</button>
                                    <button type="button" data-value="🧘">Zen Flow</button>
                                    <button type="button" data-value="🥊">Ring Ready</button>
                                    <button type="button" data-value="🚴">Cycle Champ</button>
                                    <button type="button" data-value="🛡️">Guardian</button>
                                </div>
                            </div>
                            <div>
                                <strong>Accessories</strong>
                                <div class="option-group" data-type="accessory">
                                    <button type="button" data-value="">None</button>
                                    <button type="button" data-value="⭐">Star</button>
                                    <button type="button" data-value="🔥">Flame</button>
                                    <button type="button" data-value="🎧">Beats</button>
                                    <button type="button" data-value="💥">Burst</button>
                                </div>
                            </div>
                            <div>
                                <strong>Backdrops</strong>
                                <div class="option-group" data-type="background">
                                    <button type="button" data-value="gradient">Aurora</button>
                                    <button type="button" data-value="ocean">Ocean Mist</button>
                                    <button type="button" data-value="dusk">Neon Dusk</button>
                                    <button type="button" data-value="forest">Emerald Grove</button>
                                    <button type="button" data-value="spark">Spark Storm</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="hint">These selections preview here and will be applied across the app soon.</p>
                </div>
                <div class="card">
                    <h2>Feedback</h2>
                    <form id="feedbackForm">
                        <div>
                            <label>Category</label>
                            <select id="feedbackCategory" required>
                                <option value="">Choose an option</option>
                                <option value="Suggestion">Suggestion</option>
                                <option value="Issue">Issue</option>
                                <option value="Praise">Praise</option>
                            </select>
                        </div>
                        <div>
                            <label>Message</label>
                            <textarea id="feedbackMessage" rows="4" required></textarea>
                        </div>
                        <button type="submit" class="primary-btn">Submit Feedback</button>
                    </form>
                </div>
                <div class="card">
                    <h2>Feedback Log</h2>
                    <ul class="feedback-list" id="feedbackList"></ul>
                </div>
            </section>
        </div>
    </main>
</div>

<div class="modal" id="onboardingModal">
    <div class="modal-content onboarding">
        <h2>Let’s Get Started</h2>
        <p>Tell us who you are and what you’re aiming for.</p>
        <form id="onboardingForm">
            <div>
                <label>Display Name</label>
                <input type="text" id="onboardingName" required>
            </div>
            <div>
                <label>Preferred Fitness Focus</label>
                <select id="onboardingGoal" required>
                    <option value="">Select a goal</option>
                    <option value="Build Strength">Build Strength</option>
                    <option value="Boost Endurance">Boost Endurance</option>
                    <option value="Improve Flexibility">Improve Flexibility</option>
                    <option value="Balanced Fitness">Balanced Fitness</option>
                    <option value="Mind-Body Harmony">Mind-Body Harmony</option>
                </select>
            </div>
            <button type="submit" class="primary-btn" style="width:100%; margin-top:12px;">Enter FitQuest Arcade</button>
        </form>
    </div>
</div>

<div class="modal" id="challengeDetailModal">
    <div class="modal-content">
        <button class="close-modal" id="challengeDetailClose">×</button>
        <h2 id="detailTitle"></h2>
        <div class="hint" id="detailCategory"></div>
        <div class="detail-grid" style="display:grid; gap:12px; margin:16px 0;">
            <div>Difficulty: <strong id="detailDifficulty"></strong></div>
            <div>Reward: <strong id="detailReward"></strong></div>
            <div>Estimated Time: <strong id="detailTime"></strong></div>
        </div>
        <p id="detailObjective"></p>
        <div class="detail-actions" style="display:flex; flex-direction:column; gap:12px; margin-top:22px;">
            <button class="primary-btn" id="startChallengeBtn">Start Challenge</button>
            <form id="detailReminderForm" style="display:grid; gap:10px;">
                <label>Schedule Reminder</label>
                <input type="datetime-local" id="reminderDateTime">
                <button type="submit" class="ghost-btn">Save Reminder</button>
            </form>
        </div>
    </div>
</div>

<div class="modal" id="shareModal">
    <div class="modal-content">
        <button class="close-modal" id="closeShareModal">×</button>
        <h2>Your Weekly Momentum</h2>
        <textarea id="shareText" readonly></textarea>
        <div class="modal-footer">
            <button class="primary-btn" id="copyShareBtn">Copy to Clipboard</button>
        </div>
        <div class="copy-success" id="copyFeedback" style="display:none;">Summary copied! Ready to share.</div>
    </div>
</div>

<div class="modal" id="weeklySummaryModal">
    <div class="modal-content">
        <h2>Weekly Showcase</h2>
        <div id="weeklySummaryDetails"></div>
        <div class="modal-footer">
            <button class="primary-btn" id="closeWeeklySummaryBtn">Keep Going</button>
        </div>
    </div>
</div>

<div id="tutorialOverlay">
    <div id="tutorialHighlight"></div>
    <div class="tutorial-dialog">
        <h3 id="tutorialTitle"></h3>
        <p id="tutorialText"></p>
        <div class="tutorial-actions">
            <button class="ghost-btn" id="tutorialSkip">Skip</button>
            <button class="primary-btn" id="tutorialNext">Next</button>
        </div>
    </div>
</div>

<div id="toastContainer"></div>

<script>
const STORAGE_KEY = 'fitquestArcadeState03';
const defaultChallenges = [
    {
        id: 'c1',
        name: 'Cardio Surge Circuit',
        category: 'Cardio',
        difficulty: 'Medium',
        reward: 120,
        requiredUnits: 30,
        unitLabel: 'minutes',
        timeEstimate: '30 minutes',
        objective: 'Complete a mix of high knees, jump rope, and mountain climbers for 30 minutes with minimal rest.'
    },
    {
        id: 'c2',
        name: 'Powerlift Pyramid',
        category: 'Strength',
        difficulty: 'Hard',
        reward: 180,
        requiredUnits: 24,
        unitLabel: 'sets',
        timeEstimate: '45 minutes',
        objective: 'Perform 8 sets each of squats, bench press, and deadlifts with progressive overload.'
    },
    {
        id: 'c3',
        name: 'Core Stability Flow',
        category: 'Core',
        difficulty: 'Easy',
        reward: 90,
        requiredUnits: 45,
        unitLabel: 'reps',
        timeEstimate: '25 minutes',
        objective: 'Rotate through planks, hollow holds, and Russian twists for a total of 45 quality reps.'
    },
    {
        id: 'c4',
        name: 'Mobility Mastery',
        category: 'Flexibility',
        difficulty: 'Easy',
        reward: 70,
        requiredUnits: 20,
        unitLabel: 'minutes',
        timeEstimate: '20 minutes',
        objective: 'Flow through a guided mobility routine targeting hips, shoulders, and spine.'
    },
    {
        id: 'c5',
        name: 'Mindful Tempo Run',
        category: 'Cardio',
        difficulty: 'Medium',
        reward: 140,
        requiredUnits: 5,
        unitLabel: 'km',
        timeEstimate: '28 minutes',
        objective: 'Complete a 5km tempo run focusing on controlled breathing and even pacing.'
    },
    {
        id: 'c6',
        name: 'Zen Recharge Session',
        category: 'Mindfulness',
        difficulty: 'Easy',
        reward: 60,
        requiredUnits: 3,
        unitLabel: 'cycles',
        timeEstimate: '18 minutes',
        objective: 'Practice three guided breathwork cycles followed by short meditation breaks.'
    },
    {
        id: 'c7',
        name: 'Explosive Sprint Ladder',
        category: 'Cardio',
        difficulty: 'Hard',
        reward: 200,
        requiredUnits: 12,
        unitLabel: 'rounds',
        timeEstimate: '35 minutes',
        objective: 'Run sprint intervals in a ladder pattern (30s, 45s, 60s) with active recovery.'
    }
];
const defaultLeaderboard = [
    { id: 'p1', name: 'Alex Nova', points: 2650, color: '#22d3ee' },
    { id: 'p2', name: 'Maya Flux', points: 2480, color: '#facc15' },
    { id: 'p3', name: 'Zane Drift', points: 2330, color: '#34d399' },
    { id: 'p4', name: 'Kai Ember', points: 2150, color: '#f472b6' },
    { id: 'p5', name: 'Nova Pulse', points: 1985, color: '#fb7185' },
    { id: 'p6', name: 'Jade Lynx', points: 1870, color: '#a78bfa' },
    { id: 'p7', name: 'Rey Orbit', points: 1765, color: '#38bdf8' },
    { id: 'p8', name: 'Remy Forge', points: 1650, color: '#f97316' },
    { id: 'p9', name: 'Iris Bloom', points: 1520, color: '#4ade80' },
    { id: 'p10', name: 'Noah Rift', points: 1435, color: '#fbbf24' }
];
const defaultState = {
    profile: null,
    totalPoints: 0,
    totalChallengesCompleted: 0,
    streak: {
        current: 0,
        best: 0,
        lastCheckInDate: null,
        history: [],
        restDays: []
    },
    customChallenges: [],
    activeChallenge: null,
    history: [],
    badgesEarned: [],
    activityDays: [],
    weeklySummaries: [],
    weeklySummaryLastCount: 0,
    soundEnabled: true,
    tutorialCompleted: false,
    leaderboard: {
        global: defaultLeaderboard
    },
    groupChallenges: [],
    reminders: [],
    feedbackLog: [],
    avatarSelection: {
        outfit: '👟',
        accessory: '',
        background: 'gradient'
    }
};

let state = loadState();
let allChallenges = [];
let currentFilter = 'All';
let currentDetailChallenge = null;
let activeTimerInterval = null;
let tutorialStepIndex = 0;
let audioContext = null;
let quickChallengeDraft = null;

document.addEventListener('DOMContentLoaded', initApp);

function initApp() {
    updateAllChallenges();
    setupNavigation();
    setupEventListeners();
    evaluateStreakOnLoad();
    updateLevelFromPoints();
    updateLeaderboardWithUser();
    renderAll();
    refreshActiveTimer();
    if (!state.profile) {
        toggleModal('onboardingModal', true);
    } else {
        if (!state.tutorialCompleted) {
            setTimeout(startTutorial, 600);
        }
    }
}

function loadState() {
    try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (!stored) return clone(defaultState);
        const parsed = JSON.parse(stored);
        const merged = clone(defaultState);
        mergeDeep(merged, parsed);
        return merged;
    } catch (error) {
        console.warn('Failed to load state', error);
        return clone(defaultState);
    }
}

function saveState() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (error) {
        console.warn('Failed to save state', error);
    }
}

function clone(obj) {
    return JSON.parse(JSON.stringify(obj));
}

function mergeDeep(target, source) {
    for (const key in source) {
        if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
            if (!target[key]) target[key] = {};
            mergeDeep(target[key], source[key]);
        } else {
            target[key] = source[key];
        }
    }
}

function updateAllChallenges() {
    allChallenges = defaultChallenges.map(ch => ({ ...ch }));
    if (state.customChallenges && state.customChallenges.length) {
        state.customChallenges.forEach(ch => allChallenges.push(ch));
    }
}

function setupNavigation() {
    const navButtons = document.querySelectorAll('.nav-btn');
    navButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            navButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const target = btn.dataset.view;
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(target).classList.add('active');
        });
    });
}

function setupEventListeners() {
    document.getElementById('onboardingForm').addEventListener('submit', handleOnboardingSubmit);
    document.getElementById('checkInBtn').addEventListener('click', handleCheckIn);
    document.getElementById('restDayForm').addEventListener('submit', handleRestDaySubmit);
    document.getElementById('quickChallengeBtn').addEventListener('click', generateQuickChallenge);
    document.getElementById('acceptQuickChallengeBtn').addEventListener('click', acceptQuickChallenge);
    document.getElementById('shareSummaryBtn').addEventListener('click', openShareModal);
    document.getElementById('copyShareBtn').addEventListener('click', copyShareText);
    document.getElementById('closeShareModal').addEventListener('click', () => toggleModal('shareModal', false));
    document.getElementById('customChallengeForm').addEventListener('submit', handleCustomChallengeSubmit);
    document.getElementById('challengeDetailClose').addEventListener('click', closeChallengeDetail);
    document.getElementById('startChallengeBtn').addEventListener('click', startChallengeFromDetail);
    document.getElementById('detailReminderForm').addEventListener('submit', scheduleReminderFromDetail);
    document.getElementById('closeWeeklySummaryBtn').addEventListener('click', () => toggleModal('weeklySummaryModal', false));
    document.getElementById('soundToggle').addEventListener('change', handleSoundToggle);
    document.getElementById('feedbackForm').addEventListener('submit', handleFeedbackSubmit);
    document.getElementById('groupChallengeForm').addEventListener('submit', handleGroupChallengeSubmit);
    document.getElementById('tutorialNext').addEventListener('click', nextTutorialStep);
    document.getElementById('tutorialSkip').addEventListener('click', skipTutorial);

    const challengeGrid = document.getElementById('challengeGrid');
    challengeGrid.addEventListener('click', event => {
        const card = event.target.closest('.challenge-card');
        if (!card) return;
        const id = card.dataset.id;
        const challenge = allChallenges.find(ch => ch.id === id);
        if (challenge) {
            openChallengeDetail(challenge);
        }
    });

    document.getElementById('categoryFilters').addEventListener('click', event => {
        const btn = event.target.closest('.filter-btn');
        if (!btn) return;
        currentFilter = btn.dataset.filter;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderChallengeGrid();
    });

    document.getElementById('activeContent').addEventListener('click', event => {
        if (!state.activeChallenge) return;
        if (event.target.id === 'incrementProgress') {
            adjustActiveProgress(1);
        }
        if (event.target.id === 'decrementProgress') {
            adjustActiveProgress(-1);
        }
        if (event.target.id === 'completeChallengeBtn') {
            completeActiveChallenge();
        }
        if (event.target.id === 'abandonChallengeBtn') {
            abandonActiveChallenge();
        }
    });

    document.getElementById('reminderList').addEventListener('click', event => {
        const btn = event.target.closest('button[data-reminder-id]');
        if (!btn) return;
        const id = btn.dataset.reminderId;
        state.reminders = state.reminders.filter(r => r.id !== id);
        saveState();
        renderReminders();
        renderReminderSummary();
    });

    document.getElementById('avatarOptions').addEventListener('click', event => {
        const btn = event.target.closest('button[data-value]');
        if (!btn) return;
        const group = btn.closest('.option-group');
        if (!group) return;
        group.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const type = group.dataset.type;
        const value = btn.dataset.value;
        state.avatarSelection[type] = value;
        updateAvatarPreview();
        saveState();
    });
}

function renderAll() {
    renderHeader();
    renderDashboard();
    renderActiveView();
    renderAchievements();
    renderHistory();
    renderLeaderboard();
    renderCalendar();
    renderGroupChallenges();
    renderStore();
    renderReminders();
    renderReminderSummary();
    renderFeedbackLog();
    updateAvatarOptionsState();
    updateAvatarPreview();
}

function renderHeader() {
    const nameEl = document.getElementById('headerName');
    const goalEl = document.getElementById('headerGoal');
    if (state.profile) {
        nameEl.textContent = state.profile.name;
        goalEl.textContent = state.profile.goal;
    } else {
        nameEl.textContent = 'Welcome!';
        goalEl.textContent = 'Choose your goal';
    }
    document.getElementById('headerLevel').textContent = calculateLevel(state.totalPoints);
    document.getElementById('headerPoints').textContent = Math.round(state.totalPoints);
}

function renderDashboard() {
    renderLevelCard();
    renderStreakCard();
    renderFilters();
    renderChallengeGrid();
    document.getElementById('soundToggle').checked = state.soundEnabled;
}

function renderLevelCard() {
    const level = calculateLevel(state.totalPoints);
    const currentLevelFloor = (level - 1) * 500;
    const nextLevelPoints = level * 500;
    const progress = nextLevelPoints - currentLevelFloor === 0 ? 0 : ((state.totalPoints - currentLevelFloor) / (nextLevelPoints - currentLevelFloor)) * 100;
    document.getElementById('levelProgressFill').style.width = Math.min(progress, 100) + '%';
    document.getElementById('levelProgressLabel').textContent = `Level ${level} • ${Math.round(state.totalPoints - currentLevelFloor)} / ${nextLevelPoints - currentLevelFloor} XP`;
    document.getElementById('levelDescription').textContent = `Earn ${Math.max(0, Math.round(nextLevelPoints - state.totalPoints))} more points to reach Level ${level + 1}.`;
}

function renderStreakCard() {
    document.getElementById('currentStreak').textContent = state.streak.current;
    document.getElementById('bestStreak').textContent = state.streak.best;
    const today = formatDate(new Date());
    if (state.streak.lastCheckInDate === today) {
        document.getElementById('checkInBtn').disabled = true;
        document.getElementById('checkInStatus').textContent = 'You are checked in today. Great job keeping the streak alive!';
    } else {
        document.getElementById('checkInBtn').disabled = false;
        document.getElementById('checkInStatus').textContent = 'Tap check-in once per day to maintain your streak.';
    }
}

function renderFilters() {
    const categories = ['All', ...new Set(allChallenges.map(ch => ch.category))];
    const container = document.getElementById('categoryFilters');
    container.innerHTML = categories.map(cat => `<button class="filter-btn ${cat === currentFilter ? 'active' : ''}" data-filter="${cat}">${cat}</button>`).join('');
}

function renderChallengeGrid() {
    const container = document.getElementById('challengeGrid');
    const filtered = currentFilter === 'All' ? allChallenges : allChallenges.filter(ch => ch.category === currentFilter);
    if (!filtered.length) {
        container.innerHTML = `<div class="hint">No challenges in this category yet. Create one with the builder below!</div>`;
        return;
    }
    const cards = filtered.map(ch => {
        const difficultyClass = ch.difficulty.toLowerCase();
        return `
        <div class="challenge-card" data-id="${ch.id}" data-category="${ch.category}">
            <div class="challenge-name">${ch.name}</div>
            <div class="challenge-meta">
                <span class="badge ${difficultyClass}">${ch.difficulty}</span>
                <span>${ch.reward} pts</span>
            </div>
            <div class="hint" style="margin-top:6px;">Target: ${ch.requiredUnits} ${ch.unitLabel}</div>
        </div>`;
    }).join('');
    container.innerHTML = cards;
}

function renderActiveView() {
    const container = document.getElementById('activeContent');
    if (!state.activeChallenge) {
        container.innerHTML = `
            <h2>No Active Challenge</h2>
            <p>Select a challenge from the dashboard to start tracking your progress.</p>
        `;
        clearActiveTimer();
        return;
    }
    const active = state.activeChallenge;
    const progressPercent = Math.min(100, (active.progressUnits / active.requiredUnits) * 100);
    container.innerHTML = `
        <div class="active-wrapper">
            <div>
                <div class="active-title">${active.name}</div>
                <div class="active-meta">
                    <span>Started: ${formatDateTime(active.startTime)}</span>
                    <span>Elapsed: <strong id="activeElapsed">--:--</strong></span>
                </div>
            </div>
            <div class="active-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width:${progressPercent}%"></div>
                </div>
                <div class="progress-label">${Math.round(progressPercent)}% complete • ${active.progressUnits}/${active.requiredUnits} ${active.unitLabel}</div>
            </div>
            <div class="counter-controls">
                <button id="decrementProgress">−</button>
                <div class="counter-value">${active.progressUnits}</div>
                <button id="incrementProgress">+</button>
            </div>
            <div class="hint">Each ${active.unitLabel.slice(0, -1)} logged adds ${formatNumber(active.perUnitPoints)} pts.</div>
            <div class="active-actions">
                <button class="primary-btn" id="completeChallengeBtn" ${active.progressUnits >= active.requiredUnits ? '' : 'disabled'}>Complete Challenge</button>
                <button class="secondary-btn danger-btn" id="abandonChallengeBtn">Abandon</button>
            </div>
        </div>
    `;
    refreshActiveTimer();
}

function renderAchievements() {
    const badgeContainer = document.getElementById('badgeGrid');
    const badges = getAchievementDefinitions();
    badgeContainer.innerHTML = badges.map(badge => {
        const earned = state.badgesEarned.some(b => b.id === badge.id);
        return `
            <div class="badge-card ${earned ? 'earned' : ''}">
                <h4>${badge.name}</h4>
                <p class="hint">${badge.description}</p>
                <div class="meta-line">${earned ? `Earned on ${formatDateDisplay(state.badgesEarned.find(b => b.id === badge.id).date)}` : `Goal: ${badge.goal}`}</div>
            </div>
        `;
    }).join('');
}

function renderHistory() {
    const list = document.getElementById('historyList');
    if (!state.history.length) {
        list.innerHTML = `<li class="history-item">No challenges completed yet. Finish a challenge to see it here.</li>`;
        return;
    }
    list.innerHTML = state.history.slice().reverse().map(entry => `
        <li class="history-item">
            <strong>${entry.name}</strong>
            <div class="meta-line">${formatDateDisplay(entry.date)} • ${entry.points} pts • ${entry.unitsCompleted} ${entry.unitLabel}</div>
            <div class="hint">Session length: ${entry.duration}</div>
        </li>
    `).join('');
    renderWeeklySummaryList();
}

function renderWeeklySummaryList() {
    const list = document.getElementById('weeklySummaryList');
    if (!state.weeklySummaries.length) {
        list.innerHTML = `<li class="weekly-summary-item hint">Weekly overviews appear after your first seven active days.</li>`;
        return;
    }
    list.innerHTML = state.weeklySummaries.slice().reverse().map(summary => `
        <li class="weekly-summary-item">
            <strong>${formatDateDisplay(summary.start)} → ${formatDateDisplay(summary.end)}</strong>
            <div class="meta-line">Points: ${summary.totalPoints} • Challenges: ${summary.challengesCompleted} • Avg streak: ${summary.averageStreak.toFixed(1)} days</div>
        </li>
    `).join('');
}

function renderLeaderboard() {
    const list = document.getElementById('leaderboardList');
    const entries = state.leaderboard.global.slice(0, 10);
    list.innerHTML = entries.map((entry, index) => `
        <li class="leaderboard-item">
            <span class="rank">${index + 1}</span>
            <div class="avatar-circle" style="background:${entry.color}">${entry.name.charAt(0)}</div>
            <div class="player-info">
                <span class="player-name">${entry.name}</span>
                <span class="player-score">${entry.points} pts</span>
            </div>
        </li>
    `).join('');
}

function renderCalendar() {
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const firstDay = monthStart.getDay();
    const totalDays = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
    document.getElementById('calendarMonthLabel').textContent = now.toLocaleString(undefined, { month: 'long', year: 'numeric' });

    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';
    for (let i = 0; i < firstDay; i++) {
        grid.appendChild(document.createElement('div'));
    }
    const todayStr = formatDate(now);
    for (let day = 1; day <= totalDays; day++) {
        const date = new Date(now.getFullYear(), now.getMonth(), day);
        const dateStr = formatDate(date);
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        if (dateStr === todayStr) {
            dayEl.classList.add('today');
        }
        if (state.streak.restDays.includes(dateStr)) {
            dayEl.classList.add('rest');
        }
        if (state.streak.history.some(entry => entry.date === dateStr)) {
            dayEl.classList.add('checkin');
        }
        dayEl.innerHTML = `<span class="date">${day}</span>`;
        grid.appendChild(dayEl);
    }
}

function renderGroupChallenges() {
    const list = document.getElementById('groupChallengeList');
    if (!state.groupChallenges.length) {
        list.innerHTML = `<li class="group-item hint">Create a collaborative challenge to see it listed here.</li>`;
        return;
    }
    list.innerHTML = state.groupChallenges.slice().reverse().map(group => `
        <li class="group-item">
            <strong>${group.name}</strong>
            <div class="meta-line">Target: ${group.target} units • Slots: ${group.slots}</div>
            <div class="hint">Shared progress tracking is on the roadmap.</div>
        </li>
    `).join('');
}

function renderStore() {
    const items = [
        { id: 's1', name: 'Prismatic Trail Aura', description: 'Leave a radiant trail when tracking challenges.', cost: 600 },
        { id: 's2', name: 'Retro Neon Outfit', description: 'A classic synth-wave suit for your avatar.', cost: 450 },
        { id: 's3', name: 'Midnight Skyline Backdrop', description: 'City lights backdrop for your profile.', cost: 320 },
        { id: 's4', name: 'Arcade Pulse Emote Pack', description: 'Unlock three animated celebration emotes.', cost: 520 },
        { id: 's5', name: 'Champion Nameplate', description: 'Display a glowing nameplate on leaderboards.', cost: 700 }
    ];
    const grid = document.getElementById('storeGrid');
    grid.innerHTML = items.map(item => `
        <div class="store-item">
            <strong>${item.name}</strong>
            <div class="hint">${item.description}</div>
            <div class="store-cost">${item.cost} pts</div>
            <button disabled>Redeem Coming Soon</button>
        </div>
    `).join('');
}

function renderReminders() {
    const list = document.getElementById('reminderList');
    if (!state.reminders.length) {
        list.innerHTML = `<li class="reminder-item hint">No reminders scheduled yet.</li>`;
        return;
    }
    list.innerHTML = state.reminders.slice().reverse().map(reminder => `
        <li class="reminder-item">
            <strong>${reminder.challengeName}</strong>
            <div class="meta-line">Scheduled for ${formatDateTime(reminder.datetime)}</div>
            <button class="ghost-btn" data-reminder-id="${reminder.id}">Remove</button>
        </li>
    `).join('');
}

function renderReminderSummary() {
    const list = document.getElementById('reminderSummaryList');
    if (!state.reminders.length) {
        list.innerHTML = `<li class="reminder-item hint">You haven’t scheduled any reminders yet.</li>`;
        return;
    }
    list.innerHTML = state.reminders.slice(0,3).map(reminder => `
        <li class="reminder-item">
            <strong>${reminder.challengeName}</strong>
            <div class="meta-line">${formatDateTime(reminder.datetime)}</div>
        </li>
    `).join('');
}

function renderFeedbackLog() {
    const list = document.getElementById('feedbackList');
    if (!state.feedbackLog.length) {
        list.innerHTML = `<li class="feedback-item hint">Share your thoughts and they will appear here.</li>`;
        return;
    }
    list.innerHTML = state.feedbackLog.slice().reverse().map(entry => `
        <li class="feedback-item">
            <strong>${entry.category}</strong>
            <div class="meta-line">${formatDateDisplay(entry.timestamp)}</div>
            <div>${entry.message}</div>
        </li>
    `).join('');
}

function openChallengeDetail(challenge) {
    currentDetailChallenge = challenge;
    document.getElementById('detailTitle').textContent = challenge.name;
    document.getElementById('detailCategory').textContent = `${challenge.category} • ${challenge.requiredUnits} ${challenge.unitLabel}`;
    document.getElementById('detailDifficulty').textContent = challenge.difficulty;
    document.getElementById('detailReward').textContent = `${challenge.reward} pts`;
    document.getElementById('detailTime').textContent = challenge.timeEstimate;
    document.getElementById('detailObjective').textContent = challenge.objective;
    document.getElementById('reminderDateTime').value = '';
    toggleModal('challengeDetailModal', true);
}

function closeChallengeDetail() {
    currentDetailChallenge = null;
    toggleModal('challengeDetailModal', false);
}

function startChallengeFromDetail() {
    if (!currentDetailChallenge) return;
    if (state.activeChallenge && state.activeChallenge.id !== currentDetailChallenge.id) {
        if (!confirm('Starting a new challenge will abandon your current one. Continue?')) {
            return;
        }
    }
    startChallenge(currentDetailChallenge);
    closeChallengeDetail();
}

function startChallenge(challenge) {
    const start = new Date().toISOString();
    const perUnitPoints = challenge.reward / challenge.requiredUnits;
    state.activeChallenge = {
        id: challenge.id,
        name: challenge.name,
        reward: challenge.reward,
        category: challenge.category,
        difficulty: challenge.difficulty,
        requiredUnits: challenge.requiredUnits,
        unitLabel: challenge.unitLabel,
        timeEstimate: challenge.timeEstimate,
        objective: challenge.objective,
        perUnitPoints: perUnitPoints,
        startTime: start,
        progressUnits: 0,
        pointsEarned: 0
    };
    saveState();
    renderActiveView();
    showToast(`Challenge "${challenge.name}" started.`, 'info');
}

function adjustActiveProgress(delta) {
    const active = state.activeChallenge;
    if (!active) return;
    const newValue = Math.max(0, Math.min(active.requiredUnits, active.progressUnits + delta));
    if (newValue === active.progressUnits) return;
    const diff = newValue - active.progressUnits;
    active.progressUnits = newValue;
    const pointsDelta = diff * active.perUnitPoints;
    const newTotalPoints = Math.max(0, state.totalPoints + pointsDelta);
    active.pointsEarned = Math.max(0, active.pointsEarned + pointsDelta);
    state.totalPoints = Number(newTotalPoints.toFixed(2));
    playActionSound();
    saveState();
    renderActiveView();
    renderLevelCard();
    renderHeader();
    checkAchievements();
    updateLeaderboardWithUser();
}

function completeActiveChallenge() {
    const active = state.activeChallenge;
    if (!active) return;
    const elapsed = calculateElapsed(active.startTime);
    const endDate = new Date();
    const dateStr = formatDate(endDate);
    state.history.push({
        id: `hist-${Date.now()}`,
        name: active.name,
        date: endDate.toISOString(),
        points: Math.round(active.pointsEarned),
        duration: elapsed,
        unitsCompleted: active.requiredUnits,
        unitLabel: active.unitLabel
    });
    state.totalChallengesCompleted += 1;
    state.activeChallenge = null;
    registerActivityDay(dateStr, 'challenge');
    saveState();
    renderActiveView();
    renderHistory();
    renderLevelCard();
    renderHeader();
    checkAchievements();
    updateLeaderboardWithUser();
    showToast('Challenge complete! Points added to your total.', 'success');
}

function abandonActiveChallenge() {
    if (!confirm('Abandoning will discard your current progress. Continue?')) {
        return;
    }
    state.activeChallenge = null;
    saveState();
    renderActiveView();
    showToast('Challenge abandoned. Choose a new quest to tackle!', 'warn');
}

function handleOnboardingSubmit(event) {
    event.preventDefault();
    const name = document.getElementById('onboardingName').value.trim();
    const goal = document.getElementById('onboardingGoal').value;
    if (!name || !goal) return;
    state.profile = { name, goal };
    saveState();
    renderHeader();
    toggleModal('onboardingModal', false);
    showToast(`Welcome to FitQuest Arcade, ${name}!`, 'success');
    setTimeout(startTutorial, 500);
}

function toggleModal(id, show) {
    const modal = document.getElementById(id);
    if (!modal) return;
    if (show) {
        modal.classList.add('visible');
    } else {
        modal.classList.remove('visible');
    }
}

function handleCheckIn() {
    const today = formatDate(new Date());
    if (state.streak.lastCheckInDate === today) return;
    const lastDate = state.streak.lastCheckInDate;
    if (!lastDate) {
        state.streak.current = 1;
    } else {
        const diff = daysBetween(lastDate, today);
        if (diff === 1) {
            state.streak.current += 1;
        } else if (diff > 1) {
            const missedDays = missingDays(lastDate, today);
            const protectedDays = missedDays.every(day => state.streak.restDays.includes(day));
            state.streak.current = protectedDays ? state.streak.current + 1 : 1;
        } else {
            state.streak.current += 1;
        }
    }
    state.streak.lastCheckInDate = today;
    state.streak.best = Math.max(state.streak.best, state.streak.current);
    state.streak.history.push({ date: today, streak: state.streak.current });
    registerActivityDay(today, 'check-in');
    saveState();
    renderStreakCard();
    renderCalendar();
    showToast('Check-in complete! Keep the streak alive.', 'success');
}

function handleRestDaySubmit(event) {
    event.preventDefault();
    const date = event.target.querySelector('#restDayInput').value;
    if (!date) return;
    if (!state.streak.restDays.includes(date)) {
        state.streak.restDays.push(date);
        saveState();
        renderCalendar();
        showToast(`Rest day scheduled for ${formatDateDisplay(date)}.`, 'info');
    }
    event.target.reset();
}

function evaluateStreakOnLoad() {
    const last = state.streak.lastCheckInDate;
    if (!last) return;
    const today = formatDate(new Date());
    const diff = daysBetween(last, today);
    if (diff <= 1) return;
    const missedDays = missingDays(last, today);
    const protectedDays = missedDays.every(day => state.streak.restDays.includes(day));
    if (!protectedDays) {
        state.streak.current = 0;
        saveState();
    }
}

function generateQuickChallenge() {
    const activities = [
        {
            name: 'Lightning Shadow Box',
            category: 'Cardio',
            difficulty: 'Medium',
            requiredUnits: 6,
            unitLabel: 'rounds',
            timeEstimate: '15 minutes',
            reward: 80,
            objective: 'Hit six shadow boxing rounds at high intensity with tight footwork.'
        },
        {
            name: 'Flash Plank Gauntlet',
            category: 'Core',
            difficulty: 'Medium',
            requiredUnits: 12,
            unitLabel: 'sets',
            timeEstimate: '18 minutes',
            reward: 95,
            objective: 'Alternate forearm planks and side planks for twelve rapid sets.'
        },
        {
            name: 'Pulse Jump Pyramid',
            category: 'Cardio',
            difficulty: 'Hard',
            requiredUnits: 45,
            unitLabel: 'reps',
            timeEstimate: '22 minutes',
            reward: 130,
            objective: 'Complete a pyramid of jump squats: 5-10-15-10-5 with minimal rest.'
        },
        {
            name: 'Calm Flow Stretch',
            category: 'Flexibility',
            difficulty: 'Easy',
            requiredUnits: 5,
            unitLabel: 'rounds',
            timeEstimate: '20 minutes',
            reward: 75,
            objective: 'Cycle through five rounds of hamstring, hip, and shoulder openers.'
        },
        {
            name: 'Focus Breath Ladder',
            category: 'Mindfulness',
            difficulty: 'Easy',
            requiredUnits: 4,
            unitLabel: 'cycles',
            timeEstimate: '12 minutes',
            reward: 60,
            objective: 'Complete four breath ladders: inhale 4, hold 4, exhale 4, hold 4.'
        }
    ];
    const pick = activities[Math.floor(Math.random() * activities.length)];
    const id = `quick-${Date.now()}`;
    quickChallengeDraft = {
        ...pick,
        id,
        objective: pick.objective + ' This is a rapid-fire mini mission to keep momentum high.'
    };
    const info = document.getElementById('quickChallengeInfo');
    info.innerHTML = `
        <strong>${quickChallengeDraft.name}</strong><br>
        ${quickChallengeDraft.requiredUnits} ${quickChallengeDraft.unitLabel} • ${quickChallengeDraft.reward} pts • ${quickChallengeDraft.timeEstimate}
    `;
    document.getElementById('acceptQuickChallengeBtn').disabled = false;
    showToast('Quick challenge ready! Accept to begin tracking.', 'info');
}

function acceptQuickChallenge() {
    if (!quickChallengeDraft) return;
    startChallenge(quickChallengeDraft);
    document.getElementById('quickChallengeInfo').textContent = `${quickChallengeDraft.name} is now active. Track your progress in the Active Challenge tab.`;
    document.getElementById('acceptQuickChallengeBtn').disabled = true;
    quickChallengeDraft = null;
}

function handleCustomChallengeSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const challenge = {
        id: `custom-${Date.now()}`,
        name: document.getElementById('customName').value.trim(),
        category: document.getElementById('customCategory').value,
        difficulty: document.getElementById('customDifficulty').value,
        requiredUnits: Number(document.getElementById('customUnits').value),
        unitLabel: document.getElementById('customUnitLabel').value.trim(),
        timeEstimate: document.getElementById('customTime').value.trim(),
        reward: Number(document.getElementById('customReward').value),
        objective: document.getElementById('customObjective').value.trim()
    };
    state.customChallenges.push(challenge);
    updateAllChallenges();
    saveState();
    renderFilters();
    renderChallengeGrid();
    form.reset();
    showToast('Custom challenge added to your board.', 'success');
}

function handleSoundToggle(event) {
    state.soundEnabled = event.target.checked;
    saveState();
    showToast(`Sound effects ${state.soundEnabled ? 'enabled' : 'muted'}.`, 'info');
}

function handleFeedbackSubmit(event) {
    event.preventDefault();
    const category = document.getElementById('feedbackCategory').value;
    const message = document.getElementById('feedbackMessage').value.trim();
    if (!category || !message) return;
    state.feedbackLog.push({
        id: `feedback-${Date.now()}`,
        category,
        message,
        timestamp: new Date().toISOString()
    });
    saveState();
    renderFeedbackLog();
    event.target.reset();
    showToast('Thank you for sharing feedback!', 'success');
}

function handleGroupChallengeSubmit(event) {
    event.preventDefault();
    const name = document.getElementById('groupName').value.trim();
    const target = Number(document.getElementById('groupTarget').value);
    const slots = Number(document.getElementById('groupSlots').value);
    if (!name || !target || !slots) return;
    state.groupChallenges.push({
        id: `group-${Date.now()}`,
        name,
        target,
        slots,
        created: new Date().toISOString()
    });
    saveState();
    renderGroupChallenges();
    event.target.reset();
    showToast('Group challenge created. Invite teammates to contribute!', 'info');
}

function scheduleReminderFromDetail(event) {
    event.preventDefault();
    if (!currentDetailChallenge) return;
    const datetime = document.getElementById('reminderDateTime').value;
    if (!datetime) {
        showToast('Choose a date and time for the reminder.', 'warn');
        return;
    }
    state.reminders.push({
        id: `rem-${Date.now()}`,
        challengeId: currentDetailChallenge.id,
        challengeName: currentDetailChallenge.name,
        datetime
    });
    saveState();
    renderReminders();
    renderReminderSummary();
    showToast('Reminder saved. Timed alerts will arrive soon.', 'info');
    document.getElementById('detailReminderForm').reset();
}

function openShareModal() {
    const summary = buildWeeklyShareSummary();
    document.getElementById('shareText').value = summary;
    document.getElementById('copyFeedback').style.display = 'none';
    toggleModal('shareModal', true);
}

function copyShareText() {
    const text = document.getElementById('shareText').value;
    navigator.clipboard.writeText(text).then(() => {
        document.getElementById('copyFeedback').style.display = 'block';
        showToast('Weekly summary copied!', 'success');
    }).catch(() => {
        showToast('Unable to copy summary.', 'warn');
    });
}

function buildWeeklyShareSummary() {
    const today = new Date();
    const sevenAgo = new Date(today);
    sevenAgo.setDate(today.getDate() - 6);
    const last7 = state.history.filter(entry => {
        const date = new Date(entry.date);
        return date >= sevenAgo && date <= today;
    });
    const points = last7.reduce((sum, entry) => sum + entry.points, 0);
    const streak = state.streak.current;
    const checkIns = state.streak.history.filter(entry => {
        const date = new Date(entry.date);
        return date >= sevenAgo && date <= today;
    }).length;
    return [
        `FitQuest Arcade • Weekly Progress (${formatDateDisplay(sevenAgo.toISOString())} - ${formatDateDisplay(today.toISOString())})`,
        `Total Points Earned: ${points}`,
        `Challenges Completed: ${last7.length}`,
        `Active Streak: ${streak} days`,
        `Daily Check-ins: ${checkIns}`,
        `Keep leveling up!`
    ].join('\n');
}

function registerActivityDay(dateStr, type) {
    if (!state.activityDays.includes(dateStr)) {
        state.activityDays.push(dateStr);
        state.activityDays.sort();
    }
    if (type === 'check-in' && !state.streak.history.some(entry => entry.date === dateStr)) {
        state.streak.history.push({ date: dateStr, streak: state.streak.current });
    }
    checkWeeklySummaryTrigger();
    saveState();
    renderWeeklySummaryList();
}

function checkWeeklySummaryTrigger() {
    const uniqueDays = state.activityDays;
    if (uniqueDays.length - state.weeklySummaryLastCount >= 7) {
        const lastSeven = uniqueDays.slice(-7);
        const challenges = state.history.filter(entry => lastSeven.includes(entry.date.slice(0, 10)));
        const totalPoints = challenges.reduce((sum, entry) => sum + entry.points, 0);
        const streakEntries = state.streak.history.filter(entry => lastSeven.includes(entry.date));
        const averageStreak = streakEntries.length ? streakEntries.reduce((sum, entry) => sum + entry.streak, 0) / streakEntries.length : state.streak.current;
        const summary = {
            id: `summary-${Date.now()}`,
            start: lastSeven[0],
            end: lastSeven[lastSeven.length - 1],
            totalPoints,
            challengesCompleted: challenges.length,
            averageStreak: averageStreak || 0
        };
        state.weeklySummaries.push(summary);
        state.weeklySummaryLastCount = uniqueDays.length;
        saveState();
        renderWeeklySummaryList();
        showWeeklySummary(summary);
    }
}

function showWeeklySummary(summary) {
    const container = document.getElementById('weeklySummaryDetails');
    container.innerHTML = `
        <p><strong>${formatDateDisplay(summary.start)} → ${formatDateDisplay(summary.end)}</strong></p>
        <p>Points earned: ${summary.totalPoints}</p>
        <p>Challenges completed: ${summary.challengesCompleted}</p>
        <p>Average streak: ${summary.averageStreak.toFixed(1)} days</p>
    `;
    toggleModal('weeklySummaryModal', true);
}

function calculateLevel(points) {
    return Math.floor(points / 500) + 1;
}

function updateLevelFromPoints() {
    const level = calculateLevel(state.totalPoints);
    if (state.level !== level) {
        const previousLevel = state.level || 1;
        state.level = level;
        if (level > previousLevel) {
            showToast(`Level up! You reached level ${level}.`, 'success');
        }
        saveState();
    }
}

function getAchievementDefinitions() {
    return [
        {
            id: 'badge_first_challenge',
            name: 'Trailblazer',
            description: 'Complete your first challenge session.',
            goal: '1 challenge'
        },
        {
            id: 'badge_points_500',
            name: 'Momentum Master',
            description: 'Accumulate 500 total points.',
            goal: '500 points'
        },
        {
            id: 'badge_points_1500',
            name: 'Arcade Legend',
            description: 'Hit 1,500 total points.',
            goal: '1,500 points'
        },
        {
            id: 'badge_streak_7',
            name: 'Streak Seeker',
            description: 'Maintain a 7-day check-in streak.',
            goal: '7-day streak'
        },
        {
            id: 'badge_streak_21',
            name: 'Inferno Runner',
            description: 'Keep a streak alive for 21 days.',
            goal: '21-day streak'
        },
        {
            id: 'badge_challenges_5',
            name: 'Quest Collector',
            description: 'Complete five challenges.',
            goal: '5 challenges'
        }
    ];
}

function checkAchievements() {
    const badges = getAchievementDefinitions();
    const newlyEarned = [];
    badges.forEach(badge => {
        const already = state.badgesEarned.some(b => b.id === badge.id);
        if (already) return;
        let earned = false;
        if (badge.id === 'badge_first_challenge' && state.totalChallengesCompleted >= 1) earned = true;
        if (badge.id === 'badge_points_500' && state.totalPoints >= 500) earned = true;
        if (badge.id === 'badge_points_1500' && state.totalPoints >= 1500) earned = true;
        if (badge.id === 'badge_streak_7' && state.streak.best >= 7) earned = true;
        if (badge.id === 'badge_streak_21' && state.streak.best >= 21) earned = true;
        if (badge.id === 'badge_challenges_5' && state.totalChallengesCompleted >= 5) earned = true;
        if (earned) {
            state.badgesEarned.push({ id: badge.id, date: new Date().toISOString() });
            newlyEarned.push(badge.name);
        }
    });
    if (newlyEarned.length) {
        saveState();
        renderAchievements();
        newlyEarned.forEach(name => showToast(`Badge unlocked: ${name}!`, 'success'));
    }
}

function updateLeaderboardWithUser() {
    if (!state.profile) return;
    const userId = 'you';
    const existingIndex = state.leaderboard.global.findIndex(entry => entry.id === userId);
    const color = '#6366f1';
    if (existingIndex >= 0) {
        state.leaderboard.global[existingIndex].points = Math.round(state.totalPoints);
        state.leaderboard.global[existingIndex].name = state.profile.name;
    } else {
        state.leaderboard.global.push({
            id: userId,
            name: state.profile.name,
            points: Math.round(state.totalPoints),
            color
        });
    }
    state.leaderboard.global.sort((a, b) => b.points - a.points);
    saveState();
    renderLeaderboard();
}

function refreshActiveTimer() {
    clearActiveTimer();
    if (!state.activeChallenge) return;
    const timerEl = document.getElementById('activeElapsed');
    if (!timerEl) return;
    const update = () => {
        if (!state.activeChallenge) {
            clearActiveTimer();
            return;
        }
        timerEl.textContent = calculateElapsed(state.activeChallenge.startTime);
    };
    update();
    activeTimerInterval = setInterval(update, 1000);
}

function clearActiveTimer() {
    if (activeTimerInterval) {
        clearInterval(activeTimerInterval);
        activeTimerInterval = null;
    }
}

function calculateElapsed(startTime) {
    const start = new Date(startTime);
    const now = new Date();
    const diffMs = now - start;
    const minutes = Math.floor(diffMs / 60000);
    const seconds = Math.floor((diffMs % 60000) / 1000);
    return `${pad(minutes)}:${pad(seconds)}`;
}

function pad(value) {
    return value.toString().padStart(2, '0');
}

function formatDate(date) {
    const d = new Date(date);
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function formatDateDisplay(date) {
    const d = new Date(date);
    return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
}

function formatDateTime(dateTime) {
    const d = new Date(dateTime);
    return d.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
}

function daysBetween(date1, date2) {
    const d1 = new Date(date1);
    const d2 = new Date(date2);
    const diff = Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));
    return diff;
}

function missingDays(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    const missing = [];
    const diff = daysBetween(startDate, endDate);
    for (let i = 1; i < diff; i++) {
        const intermediate = new Date(start);
        intermediate.setDate(start.getDate() + i);
        missing.push(formatDate(intermediate));
    }
    return missing;
}

function formatNumber(value) {
    return Math.round(value * 100) / 100;
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
        toast.remove();
    }, 4500);
}

function playActionSound() {
    if (!state.soundEnabled) return;
    try {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        const oscillator = audioContext.createOscillator();
        const gain = audioContext.createGain();
        oscillator.type = 'triangle';
        oscillator.frequency.value = 520;
        gain.gain.value = 0.08;
        oscillator.connect(gain);
        gain.connect(audioContext.destination);
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.12);
    } catch (error) {
        console.warn('Audio not available', error);
    }
}

function startTutorial() {
    if (!document.body.contains(document.getElementById('tutorialOverlay'))) return;
    const overlay = document.getElementById('tutorialOverlay');
    overlay.classList.add('active');
    overlay.style.pointerEvents = 'auto';
    tutorialStepIndex = 0;
    showTutorialStep();
}

function showTutorialStep() {
    const steps = [
        { selector: '#levelCard', title: 'Track Your Level', text: 'This tile shows how close you are to your next level. Earn points by completing challenges.' },
        { selector: '#streakCard', title: 'Maintain Your Streak', text: 'Check in daily to keep your streak alive and earn badge rewards.' },
        { selector: '#challengeGrid', title: 'Daily Challenges', text: 'Browse and start challenges tailored to different focus areas.' },
        { selector: '.sidebar', title: 'Explore Tabs', text: 'Use the navigation to view your active challenge, achievements, history, and more.' }
    ];
    if (tutorialStepIndex >= steps.length) {
        finishTutorial();
        return;
    }
    const step = steps[tutorialStepIndex];
    const element = document.querySelector(step.selector);
    const highlight = document.getElementById('tutorialHighlight');
    const titleEl = document.getElementById('tutorialTitle');
    const textEl = document.getElementById('tutorialText');
    if (element) {
        const rect = element.getBoundingClientRect();
        highlight.style.top = `${rect.top - 8}px`;
        highlight.style.left = `${rect.left - 8}px`;
        highlight.style.width = `${rect.width + 16}px`;
        highlight.style.height = `${rect.height + 16}px`;
        highlight.style.display = 'block';
    } else {
        highlight.style.display = 'none';
    }
    titleEl.textContent = step.title;
    textEl.textContent = step.text;
}

function nextTutorialStep() {
    tutorialStepIndex += 1;
    showTutorialStep();
}

function skipTutorial() {
    finishTutorial();
}

function finishTutorial() {
    const overlay = document.getElementById('tutorialOverlay');
    overlay.classList.remove('active');
    overlay.style.pointerEvents = 'none';
    state.tutorialCompleted = true;
    saveState();
}

function updateAvatarPreview() {
    const preview = document.getElementById('avatarPreview');
    const outfit = state.avatarSelection.outfit || '👟';
    const accessory = state.avatarSelection.accessory || '';
    const background = state.avatarSelection.background || 'gradient';
    preview.textContent = outfit;
    preview.dataset.accessory = accessory;
    let gradient;
    switch (background) {
        case 'ocean':
            gradient = 'linear-gradient(135deg, rgba(56,189,248,0.5), rgba(15,118,110,0.45))';
            break;
        case 'dusk':
            gradient = 'linear-gradient(135deg, rgba(67,56,202,0.45), rgba(236,72,153,0.45))';
            break;
        case 'forest':
            gradient = 'linear-gradient(135deg, rgba(34,197,94,0.45), rgba(16,185,129,0.45))';
            break;
        case 'spark':
            gradient = 'linear-gradient(135deg, rgba(250,204,21,0.5), rgba(244,114,182,0.4))';
            break;
        default:
            gradient = 'linear-gradient(135deg, rgba(99,102,241,0.45), rgba(34,211,238,0.35))';
    }
    preview.style.background = gradient;
}

function updateAvatarOptionsState() {
    document.querySelectorAll('#avatarOptions .option-group').forEach(group => {
        const type = group.dataset.type;
        group.querySelectorAll('button').forEach(btn => {
            if (state.avatarSelection[type] === btn.dataset.value) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    });
}

function refreshActiveTimer() {
    clearActiveTimer();
    if (!state.activeChallenge) return;
    const timerEl = document.getElementById('activeElapsed');
    if (!timerEl) return;
    const update = () => {
        if (!state.activeChallenge) {
            clearActiveTimer();
            return;
        }
        timerEl.textContent = calculateElapsed(state.activeChallenge.startTime);
    };
    update();
    activeTimerInterval = setInterval(update, 1000);
}

</script>
</body>
</html>