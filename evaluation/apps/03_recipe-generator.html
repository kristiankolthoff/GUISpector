<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Recipe Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root {
    --bg: #f4f6fb;
    --surface: #ffffff;
    --primary: #2c7be5;
    --primary-dark: #1b5bbf;
    --accent: #52c41a;
    --warning: #f59e0b;
    --danger: #f56565;
    --text: #1f2933;
    --muted: #6b7c93;
    --border: #e0e6ed;
    --shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
}

* {
    box-sizing: border-box;
}

body {
    margin: 0;
    font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
}

header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    box-shadow: var(--shadow);
    position: sticky;
    top: 0;
    z-index: 10;
}

.header-inner {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem 1.5rem;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1rem;
    justify-content: space-between;
}

.branding {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.branding h1 {
    margin: 0;
    font-size: 1.75rem;
    color: var(--primary);
}

.branding span {
    font-size: 0.95rem;
    color: var(--muted);
}

nav {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

nav button {
    border: none;
    background: transparent;
    padding: 0.65rem 1.2rem;
    border-radius: 999px;
    cursor: pointer;
    font-weight: 600;
    color: var(--muted);
    transition: background 0.25s, color 0.25s, transform 0.25s;
}

nav button:hover {
    background: rgba(44, 123, 229, 0.1);
    color: var(--primary);
    transform: translateY(-1px);
}

nav button.active {
    background: var(--primary);
    color: #fff;
    box-shadow: 0 8px 20px rgba(44, 123, 229, 0.35);
}

main {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1.5rem 3rem;
}

.view {
    display: none;
    animation: fadeIn 0.3s ease;
}

.view.active {
    display: block;
}

.section-header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.section-header h2 {
    margin: 0;
    font-size: 1.6rem;
}

.card {
    background: var(--surface);
    border-radius: 16px;
    box-shadow: var(--shadow);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(0,0,0,0.03);
}

.summary-grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
}

.summary-tile {
    background: linear-gradient(135deg, rgba(44,123,229,0.1), rgba(44,123,229,0));
    border-radius: 14px;
    padding: 1rem;
    border: 1px solid rgba(44, 123, 229, 0.15);
}

.summary-tile strong {
    display: block;
    font-size: 2rem;
    margin-top: 0.35rem;
    color: var(--primary);
}

.quick-add {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.25rem;
}

.quick-add button {
    border: 1px solid var(--border);
    border-radius: 999px;
    padding: 0.45rem 1rem;
    background: #fff;
    cursor: pointer;
    color: var(--muted);
    transition: background 0.2s, border 0.2s, color 0.2s;
}

.quick-add button:hover {
    background: rgba(44,123,229,0.1);
    border-color: rgba(44,123,229,0.4);
    color: var(--primary-dark);
}

.add-ingredient-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 0.75rem;
    align-items: center;
}

.add-ingredient-form input[type="text"] {
    padding: 0.65rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 0.95rem;
}

.add-ingredient-form button {
    padding: 0.7rem 1.2rem;
    border: none;
    border-radius: 10px;
    background: var(--primary);
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.25s, transform 0.2s;
}

.add-ingredient-form button:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
}

.sort-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 1.5rem 0 0.75rem;
}

.sort-controls button {
    border: 1px solid var(--border);
    background: #fff;
    border-radius: 8px;
    padding: 0.45rem 0.9rem;
    cursor: pointer;
    color: var(--muted);
    transition: background 0.2s, border 0.2s, color 0.2s;
}

.sort-controls button.active {
    background: rgba(44,123,229,0.12);
    border-color: rgba(44,123,229,0.4);
    color: var(--primary-dark);
    font-weight: 600;
}

#ingredientList {
    display: grid;
    gap: 1rem;
}

.ingredient-card {
    background: #fff;
    border-radius: 14px;
    padding: 1rem 1.1rem;
    border: 1px solid rgba(15,23,42,0.08);
    display: grid;
    gap: 0.75rem;
    position: relative;
}

.ingredient-card.dragging {
    opacity: 0.6;
}

.drag-handle {
    position: absolute;
    right: 1rem;
    top: 1rem;
    cursor: grab;
    color: var(--muted);
    font-size: 1.1rem;
}

.ingredient-card h3 {
    margin: 0;
    font-size: 1.1rem;
}

.ingredient-header {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.badge {
    font-size: 0.75rem;
    padding: 0.15rem 0.5rem;
    border-radius: 999px;
}

.badge.in {
    background: rgba(82,196,26,0.15);
    color: var(--accent);
}

.badge.out {
    background: rgba(245,101,101,0.15);
    color: var(--danger);
}

.note {
    margin: 0;
    color: var(--muted);
    font-size: 0.9rem;
}

.ingredient-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.ingredient-actions button {
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.35rem 0.75rem;
    background: #fff;
    cursor: pointer;
    font-size: 0.85rem;
    color: var(--muted);
    transition: border 0.2s, color 0.2s, background 0.2s;
}

.ingredient-actions button:hover {
    border-color: rgba(44,123,229,0.35);
    color: var(--primary-dark);
}

.ingredient-card.use-soon {
    border-left: 4px solid var(--warning);
    background: linear-gradient(135deg, rgba(245,158,11,0.12), rgba(255,255,255,0));
}

.edit-area {
    display: none;
    border-top: 1px dashed var(--border);
    padding-top: 0.75rem;
    gap: 0.5rem;
}

.ingredient-card.editing .edit-area {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 0.75rem;
}

.ingredient-card.editing .display-area {
    display: none;
}

.edit-area input {
    width: 100%;
    padding: 0.55rem 0.65rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.9rem;
}

.edit-area .edit-actions {
    display: flex;
    gap: 0.5rem;
    grid-column: 1 / -1;
}

.edit-area .edit-actions button {
    flex: 1;
    padding: 0.55rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: opacity 0.2s;
}

.edit-area .save-edit {
    background: var(--accent);
    color: #fff;
}

.edit-area .cancel-edit {
    background: rgba(107,124,147,0.1);
    color: var(--muted);
}

.recipe-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
    margin-bottom: 1rem;
}

.recipe-toolbar button.primary {
    background: var(--primary);
    color: #fff;
    border: none;
    border-radius: 10px;
    padding: 0.6rem 1.2rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s, transform 0.2s;
}

.recipe-toolbar button.primary:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
}

.recipe-toolbar button.secondary {
    border: 1px solid var(--border);
    background: #fff;
    border-radius: 10px;
    padding: 0.6rem 1.2rem;
    cursor: pointer;
    color: var(--muted);
    transition: border 0.2s, color 0.2s, background 0.2s;
}

.recipe-toolbar button.secondary:hover {
    border-color: rgba(44,123,229,0.35);
    color: var(--primary);
    background: rgba(44,123,229,0.08);
}

.filter-group {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.filter-group button {
    border: 1px solid var(--border);
    border-radius: 999px;
    padding: 0.35rem 0.95rem;
    background: #fff;
    cursor: pointer;
    color: var(--muted);
    transition: background 0.2s, color 0.2s, border 0.2s;
}

.filter-group button.active {
    background: rgba(44,123,229,0.15);
    border-color: rgba(44,123,229,0.4);
    color: var(--primary-dark);
    font-weight: 600;
}

.recipe-toolbar input[type="search"] {
    flex: 1 1 220px;
    padding: 0.65rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 0.95rem;
}

.recipe-list {
    display: grid;
    gap: 1rem;
}

.recipe-card {
    background: #fff;
    border-radius: 16px;
    border: 1px solid rgba(15,23,42,0.06);
    box-shadow: var(--shadow);
    padding: 1.2rem;
    display: grid;
    gap: 0.9rem;
}

.recipe-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 0.75rem;
}

.recipe-header h3 {
    margin: 0;
    font-size: 1.2rem;
}

.meal-type {
    font-size: 0.75rem;
    padding: 0.2rem 0.55rem;
    border-radius: 999px;
    background: rgba(44,123,229,0.12);
    color: var(--primary-dark);
    display: inline-block;
    margin-top: 0.35rem;
}

.favorite-btn {
    border: none;
    background: transparent;
    font-size: 1.35rem;
    cursor: pointer;
    color: #facc15;
    transition: transform 0.2s;
}

.favorite-btn:hover {
    transform: scale(1.1);
}

.recipe-counts {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    font-size: 0.9rem;
}

.recipe-counts span {
    background: rgba(44,123,229,0.08);
    color: var(--primary-dark);
    padding: 0.25rem 0.6rem;
    border-radius: 999px;
}

.recipe-counts .missing {
    background: rgba(245,101,101,0.12);
    color: var(--danger);
}

.ingredients-summary {
    display: grid;
    gap: 0.75rem;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
}

.ingredients-summary h4 {
    margin: 0 0 0.35rem;
    font-size: 0.95rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.04em;
}

.ingredients-summary ul {
    margin: 0;
    padding-left: 1.1rem;
    color: var(--text);
    font-size: 0.9rem;
}

.ingredients-summary li.missing {
    color: var(--danger);
}

.recipe-actions {
    display: flex;
    gap: 0.6rem;
    flex-wrap: wrap;
}

.recipe-actions button {
    flex: 1;
    min-width: 140px;
    border: none;
    border-radius: 10px;
    padding: 0.6rem 0.9rem;
    cursor: pointer;
    font-weight: 600;
    transition: transform 0.2s, background 0.2s;
}

.recipe-actions .detail-btn {
    background: var(--primary);
    color: #fff;
}

.recipe-actions .shopping-btn {
    background: rgba(44,123,229,0.08);
    color: var(--primary-dark);
}

.recipe-actions button:hover {
    transform: translateY(-1px);
}

.custom-recipe-card {
    margin-top: 2rem;
}

.custom-recipe-form {
    display: grid;
    gap: 1rem;
}

.custom-recipe-form input,
.custom-recipe-form select,
.custom-recipe-form textarea {
    width: 100%;
    padding: 0.65rem 0.75rem;
    border-radius: 10px;
    border: 1px solid var(--border);
    font-size: 0.95rem;
    resize: vertical;
}

.custom-recipe-form .checkbox-grid {
    display: grid;
    gap: 0.35rem;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    max-height: 160px;
    overflow-y: auto;
    padding: 0.5rem 0.25rem;
    border: 1px solid rgba(15,23,42,0.06);
    border-radius: 10px;
    background: rgba(244,246,251,0.6);
}

.custom-recipe-form button {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 0.7rem 1.2rem;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s, transform 0.2s;
}

.custom-recipe-form button:hover {
    background: #3aa110;
    transform: translateY(-1px);
}

.overlay {
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.42);
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 3rem 1rem;
    overflow-y: auto;
    z-index: 20;
}

.overlay.hidden {
    display: none;
}

.overlay-content {
    background: #fff;
    border-radius: 20px;
    max-width: 760px;
    width: 100%;
    box-shadow: 0 30px 60px rgba(15,23,42,0.25);
    position: relative;
    padding: 2rem;
    margin-bottom: 2rem;
}

.close-overlay {
    position: absolute;
    right: 1.5rem;
    top: 1.25rem;
    background: rgba(107,124,147,0.12);
    border: none;
    border-radius: 999px;
    width: 36px;
    height: 36px;
    cursor: pointer;
    font-size: 1.2rem;
    color: var(--muted);
}

.close-overlay:hover {
    background: rgba(44,123,229,0.15);
    color: var(--primary-dark);
}

.detail-header h2 {
    margin: 0;
    font-size: 1.7rem;
}

.detail-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin: 1rem 0;
}

.detail-meta .stat {
    background: rgba(44,123,229,0.08);
    color: var(--primary-dark);
    padding: 0.45rem 0.75rem;
    border-radius: 10px;
    font-weight: 600;
}

.servings-selector {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.4rem 0.6rem;
    background: rgba(107,124,147,0.1);
    border-radius: 8px;
    font-size: 0.9rem;
}

.servings-selector select {
    border: none;
    background: transparent;
    font-weight: 600;
    cursor: pointer;
}

.detail-ingredients,
.detail-instructions {
    margin-top: 1.5rem;
}

.detail-ingredients ul,
.detail-instructions ol {
    margin: 0.75rem 0 0;
    padding-left: 1.2rem;
}

.detail-ingredients li {
    margin-bottom: 0.3rem;
}

.detail-ingredients li.missing {
    color: var(--danger);
}

.substitution-block {
    margin-top: 0.5rem;
    padding: 0.6rem 0.75rem;
    background: rgba(44,123,229,0.06);
    border-radius: 10px;
    display: grid;
    gap: 0.35rem;
}

.substitution-block select {
    padding: 0.45rem 0.65rem;
    border-radius: 8px;
    border: 1px solid var(--border);
    font-size: 0.9rem;
}

.detail-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 2rem;
    flex-wrap: wrap;
}

.detail-actions button {
    flex: 1;
    border: none;
    border-radius: 10px;
    padding: 0.75rem 1rem;
    font-weight: 600;
    cursor: pointer;
}

.detail-actions .guided-btn {
    background: var(--primary);
    color: #fff;
}

.detail-actions .shopping-btn {
    background: rgba(44,123,229,0.08);
    color: var(--primary-dark);
}

.guided {
    max-width: 520px;
    padding: 1.75rem;
}

.guided h2 {
    margin-top: 0;
}

.guided-step {
    margin: 1rem 0 1.5rem;
    background: rgba(44,123,229,0.08);
    border-radius: 12px;
    padding: 1.2rem;
}

.guided-step .count {
    font-weight: 600;
    color: var(--primary-dark);
    margin-bottom: 0.4rem;
}

.guided-controls {
    display: flex;
    gap: 0.75rem;
}

.guided-controls button {
    flex: 1;
    border: none;
    border-radius: 10px;
    padding: 0.65rem;
    cursor: pointer;
    font-weight: 600;
    background: rgba(44,123,229,0.1);
    color: var(--primary-dark);
}

.guided-controls button.primary {
    background: var(--primary);
    color: #fff;
}

.guided-controls button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.meal-planner-grid {
    display: grid;
    gap: 1rem;
}

.planner-day {
    background: #fff;
    border: 1px solid rgba(15,23,42,0.05);
    border-radius: 16px;
    padding: 1.2rem;
    box-shadow: var(--shadow);
}

.planner-day h3 {
    margin: 0 0 0.75rem;
    font-size: 1.1rem;
}

.meal-slot {
    display: grid;
    gap: 0.35rem;
    margin-bottom: 0.9rem;
}

.meal-slot label {
    font-size: 0.85rem;
    color: var(--muted);
    font-weight: 600;
}

.meal-slot select {
    padding: 0.55rem 0.65rem;
    border-radius: 10px;
    border: 1px solid var(--border);
    font-size: 0.9rem;
    cursor: pointer;
}

.meal-slot button {
    justify-self: flex-end;
    border: none;
    background: rgba(245,101,101,0.15);
    color: var(--danger);
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    font-size: 0.75rem;
    cursor: pointer;
}

.empty-state {
    padding: 1.2rem;
    background: rgba(15,23,42,0.05);
    border-radius: 14px;
    text-align: center;
    color: var(--muted);
}

.shopping-list {
    display: grid;
    gap: 1rem;
}

.shopping-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    border-radius: 12px;
    padding: 0.85rem 1rem;
    border: 1px solid rgba(15,23,42,0.05);
    box-shadow: var(--shadow);
}

.shopping-item button {
    border: none;
    background: rgba(245,101,101,0.14);
    color: var(--danger);
    border-radius: 8px;
    padding: 0.35rem 0.65rem;
    cursor: pointer;
    font-size: 0.85rem;
}

.status-message {
    margin-top: 0.75rem;
    font-size: 0.9rem;
    color: var(--accent);
    display: none;
}

.status-message.visible {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
}

@media (min-width: 900px) {
    .recipe-layout {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
    }
}

body.no-scroll {
    overflow: hidden;
}
</style>
</head>
<body>
<header>
    <div class="header-inner">
        <div class="branding">
            <h1>Recipe Generator</h1>
            <span>Create meals around what you already have</span>
        </div>
        <nav>
            <button class="active" data-nav="inventory">Inventory</button>
            <button data-nav="recipes">Recipes</button>
            <button data-nav="meal-planner">Meal Planner</button>
            <button data-nav="favorites">Favorites</button>
            <button data-nav="shopping">Shopping List</button>
        </nav>
    </div>
</header>
<main>
    <section class="view active" data-view="inventory">
        <div class="section-header">
            <h2>Your Fridge</h2>
        </div>
        <div class="card">
            <div class="summary-grid">
                <div class="summary-tile">
                    <span>Total Ingredients</span>
                    <strong id="totalCount">0</strong>
                </div>
                <div class="summary-tile">
                    <span>In Fridge</span>
                    <strong id="inFridgeCount">0</strong>
                </div>
                <div class="summary-tile">
                    <span>Out of Stock</span>
                    <strong id="outCount">0</strong>
                </div>
            </div>
        </div>
        <div class="card">
            <h3>Add Ingredient</h3>
            <div class="quick-add" id="quickAddPanel">
                <button data-quick="Eggs">Eggs</button>
                <button data-quick="Milk">Milk</button>
                <button data-quick="Butter">Butter</button>
                <button data-quick="Spinach">Spinach</button>
                <button data-quick="Chicken Breast">Chicken Breast</button>
                <button data-quick="Tomatoes">Tomatoes</button>
                <button data-quick="Cheddar Cheese">Cheddar Cheese</button>
                <button data-quick="Bread">Bread</button>
            </div>
            <form class="add-ingredient-form" id="addIngredientForm">
                <input type="text" id="ingredientName" placeholder="e.g. Fresh basil" required>
                <input type="text" id="ingredientNote" placeholder="Quantity or notes (optional)">
                <button type="submit">Add to Inventory</button>
            </form>
            <div class="sort-controls">
                <span>Sort by:</span>
                <button class="active" data-sort="recent">Most Recent</button>
                <button data-sort="alpha">Alphabetical</button>
            </div>
            <div id="ingredientList"></div>
        </div>
    </section>

    <section class="view" data-view="recipes">
        <div class="section-header">
            <h2>Recipe Ideas</h2>
        </div>
        <div class="card">
            <div class="recipe-toolbar">
                <button class="primary" id="findRecipesBtn">Find Recipes</button>
                <button class="secondary" id="surpriseBtn">Surprise Me</button>
                <div class="filter-group" id="mealTypeFilters">
                    <button data-meal="Breakfast">Breakfast</button>
                    <button data-meal="Lunch">Lunch</button>
                    <button data-meal="Dinner">Dinner</button>
                    <button data-meal="Snack">Snack</button>
                </div>
                <input type="search" id="recipeSearch" placeholder="Search by name or keyword">
            </div>
            <div class="recipe-layout">
                <div>
                    <div class="recipe-list" id="recipeList"></div>
                </div>
                <div>
                    <div class="card custom-recipe-card">
                        <h3>Create Custom Recipe</h3>
                        <form class="custom-recipe-form" id="customRecipeForm">
                            <input type="text" id="customRecipeName" placeholder="Recipe name" required>
                            <select id="customRecipeMeal" required>
                                <option value="">Select meal type</option>
                                <option>Breakfast</option>
                                <option>Lunch</option>
                                <option>Dinner</option>
                                <option>Snack</option>
                            </select>
                            <input type="text" id="customRecipeTags" placeholder="Tags (comma separated)">
                            <div>
                                <label for="customRecipeIngredients">Select ingredients</label>
                                <div class="checkbox-grid" id="customIngredientOptions"></div>
                            </div>
                            <textarea id="customRecipeExtraIngredients" rows="2" placeholder="Additional ingredients (comma separated, optional)"></textarea>
                            <textarea id="customRecipeInstructions" rows="5" placeholder="Step-by-step instructions (one per line)" required></textarea>
                            <button type="submit">Save Custom Recipe</button>
                            <div class="status-message" id="customRecipeStatus">Recipe saved!</div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="view" data-view="meal-planner">
        <div class="section-header">
            <h2>Weekly Meal Planner</h2>
        </div>
        <div class="card">
            <p>Plan out the next seven days by assigning recipes to each meal.</p>
            <div class="meal-planner-grid" id="mealPlannerGrid"></div>
        </div>
    </section>

    <section class="view" data-view="favorites">
        <div class="section-header">
            <h2>Saved Recipes</h2>
        </div>
        <div class="card">
            <div class="recipe-list" id="favoritesList"></div>
        </div>
    </section>

    <section class="view" data-view="shopping">
        <div class="section-header">
            <h2>Shopping List Queue</h2>
        </div>
        <div class="card">
            <p>Add recipes to this queue to create your next grocery run. Items are grouped by recipe for quick reference.</p>
            <div class="shopping-list" id="shoppingListItems"></div>
        </div>
    </section>
</main>

<div class="overlay hidden" id="recipeDetailOverlay">
    <div class="overlay-content" id="recipeDetailContent">
        <button class="close-overlay" id="closeDetail">&times;</button>
    </div>
</div>

<div class="overlay hidden" id="guidedModeOverlay">
    <div class="overlay-content guided">
        <button class="close-overlay" id="closeGuided">&times;</button>
        <h2 id="guidedTitle">Guided Cooking</h2>
        <div class="guided-step">
            <div class="count" id="guidedStepCount">Step 1 of 1</div>
            <p id="guidedStepText">Follow the instructions.</p>
        </div>
        <div class="guided-controls">
            <button id="prevStep">Previous</button>
            <button class="primary" id="nextStep">Next</button>
        </div>
    </div>
</div>

<script>
const baseRecipes = [
    {
        id: "recipe-1",
        name: "Garden Omelette",
        mealType: "Breakfast",
        tags: ["eggs", "quick", "vegetarian"],
        ingredients: [
            { name: "Eggs", amount: "3" },
            { name: "Spinach", amount: "1 cup" },
            { name: "Mushrooms", amount: "1/2 cup" },
            { name: "Cheddar Cheese", amount: "1/4 cup" },
            { name: "Salt", amount: "to taste" },
            { name: "Black Pepper", amount: "to taste" }
        ],
        instructions: [
            { text: "Whisk eggs with salt and pepper until fluffy." },
            { text: "Sauté mushrooms and spinach in a non-stick skillet for 2 minutes.", duration: 2 },
            { text: "Pour eggs over vegetables and cook until nearly set.", duration: 3 },
            { text: "Sprinkle cheese on top, fold, and finish cooking for another minute." }
        ]
    },
    {
        id: "recipe-2",
        name: "Lemon Herb Chicken Stir Fry",
        mealType: "Dinner",
        tags: ["chicken", "weeknight", "gluten-free"],
        ingredients: [
            { name: "Chicken Breast", amount: "2 cups" },
            { name: "Broccoli", amount: "1 cup" },
            { name: "Bell Pepper", amount: "1 cup" },
            { name: "Soy Sauce", amount: "3 tbsp" },
            { name: "Garlic", amount: "2 cloves" },
            { name: "Lemon", amount: "1/2" },
            { name: "Olive Oil", amount: "2 tbsp" }
        ],
        instructions: [
            { text: "Slice chicken and vegetables into bite-sized pieces." },
            { text: "Heat olive oil in a wok and cook chicken until browned.", duration: 5 },
            { text: "Add vegetables and stir fry until crisp-tender.", duration: 4 },
            { text: "Stir in soy sauce, minced garlic, and a squeeze of lemon. Toss to coat." }
        ]
    },
    {
        id: "recipe-3",
        name: "Caprese Avocado Toast",
        mealType: "Breakfast",
        tags: ["vegetarian", "toast", "brunch"],
        ingredients: [
            { name: "Bread", amount: "2 slices" },
            { name: "Avocado", amount: "1" },
            { name: "Tomatoes", amount: "1/2 cup" },
            { name: "Mozzarella", amount: "1/4 cup" },
            { name: "Basil", amount: "4 leaves" },
            { name: "Balsamic Vinegar", amount: "1 tsp" }
        ],
        instructions: [
            { text: "Toast bread slices until golden." },
            { text: "Mash avocado with a pinch of salt and spread over toast." },
            { text: "Layer sliced tomatoes and mozzarella on top." },
            { text: "Drizzle with balsamic vinegar and garnish with basil leaves." }
        ]
    },
    {
        id: "recipe-4",
        name: "Quinoa Mediterranean Salad",
        mealType: "Lunch",
        tags: ["healthy", "gluten-free", "make-ahead"],
        ingredients: [
            { name: "Quinoa", amount: "1 cup" },
            { name: "Cucumber", amount: "1 cup" },
            { name: "Tomatoes", amount: "1 cup" },
            { name: "Feta Cheese", amount: "1/3 cup" },
            { name: "Olive Oil", amount: "3 tbsp" },
            { name: "Lemon", amount: "1" },
            { name: "Red Onion", amount: "1/4 cup" },
            { name: "Parsley", amount: "2 tbsp" }
        ],
        instructions: [
            { text: "Cook quinoa according to package instructions and let cool." },
            { text: "Dice cucumber, tomatoes, red onion, and parsley." },
            { text: "Combine quinoa and vegetables in a large bowl." },
            { text: "Whisk olive oil with lemon juice and toss with salad." },
            { text: "Crumble feta over the top before serving." }
        ]
    },
    {
        id: "recipe-5",
        name: "Berry Yogurt Parfait",
        mealType: "Snack",
        tags: ["no-cook", "sweet", "quick"],
        ingredients: [
            { name: "Greek Yogurt", amount: "1 cup" },
            { name: "Granola", amount: "1/2 cup" },
            { name: "Mixed Berries", amount: "1 cup" },
            { name: "Honey", amount: "1 tbsp" }
        ],
        instructions: [
            { text: "Layer half of the yogurt in a glass." },
            { text: "Add berries and granola, drizzle with honey." },
            { text: "Repeat layers and serve immediately." }
        ]
    },
    {
        id: "recipe-6",
        name: "Creamy Tomato Pasta",
        mealType: "Dinner",
        tags: ["comfort food", "pasta", "family"],
        ingredients: [
            { name: "Pasta", amount: "12 oz" },
            { name: "Tomatoes", amount: "2 cups" },
            { name: "Garlic", amount: "3 cloves" },
            { name: "Cream", amount: "1/2 cup" },
            { name: "Parmesan", amount: "1/4 cup" },
            { name: "Olive Oil", amount: "2 tbsp" },
            { name: "Basil", amount: "1/4 cup" }
        ],
        instructions: [
            { text: "Cook pasta until al dente and reserve some cooking water." },
            { text: "Sauté garlic in olive oil until fragrant.", duration: 2 },
            { text: "Add diced tomatoes and simmer until softened.", duration: 5 },
            { text: "Pour in cream, add cooked pasta, and toss with parmesan and basil." }
        ]
    }
];

const substitutionMap = {
    "milk": ["Almond Milk", "Oat Milk", "Coconut Milk"],
    "butter": ["Olive Oil", "Coconut Oil", "Ghee"],
    "eggs": ["Flaxseed Meal", "Applesauce", "Chia Seeds"],
    "cheddar cheese": ["Monterey Jack", "Gouda", "Vegan Cheddar"],
    "chicken breast": ["Tofu Cubes", "Chickpeas", "Turkey Breast"],
    "tomatoes": ["Roasted Red Peppers", "Sun-dried Tomatoes"],
    "spinach": ["Kale", "Arugula"],
    "yogurt": ["Coconut Yogurt", "Skyr"],
    "honey": ["Maple Syrup", "Agave Nectar"],
    "garlic": ["Shallots", "Garlic Powder"],
    "pasta": ["Zucchini Noodles", "Whole Wheat Pasta"]
};

const mealSlots = ["Breakfast", "Lunch", "Dinner"];

let inventory = [];
let currentSort = "recent";
let favorites = new Set();
let customRecipes = [];
let latestComputedRecipes = [];
let currentRecipeList = [];
let selectedMealTypes = new Set();
let substitutions = {};
let shoppingQueue = [];
let mealPlannerSelections = {};
let currentDetailRecipeId = null;
let guidedModeState = null;
let draggedIngredientId = null;

document.addEventListener("DOMContentLoaded", () => {
    inventory = loadInventory();
    favorites = loadFavorites();
    customRecipes = loadCustomRecipes();
    substitutions = loadSubstitutions();
    shoppingQueue = loadShoppingQueue();
    renderInventory();
    updateInventorySummary();
    renderCustomIngredientOptions();
    setupNav();
    setupInventoryActions();
    setupRecipeActions();
    renderMealPlanner();
    updateRecipeList();
    renderShoppingList();
});

function setupNav() {
    const navButtons = document.querySelectorAll("nav button[data-nav]");
    navButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            navButtons.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            const viewName = btn.dataset.nav;
            document.querySelectorAll(".view").forEach(section => {
                section.classList.toggle("active", section.dataset.view === viewName);
            });
        });
    });
}

function setupInventoryActions() {
    document.getElementById("quickAddPanel").addEventListener("click", (e) => {
        if (e.target.matches("button[data-quick]")) {
            handleQuickAdd(e.target.dataset.quick);
        }
    });

    document.getElementById("addIngredientForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const nameInput = document.getElementById("ingredientName");
        const noteInput = document.getElementById("ingredientNote");
        const name = nameInput.value.trim();
        if (!name) return;
        const note = noteInput.value.trim();
        const newIngredient = {
            id: generateId("ing"),
            name,
            note,
            available: true,
            useSoon: false,
            createdAt: Date.now(),
            updatedAt: Date.now(),
            expiration: ""
        };
        inventory.unshift(newIngredient);
        currentSort = "recent";
        persistInventory();
        refreshInventoryUI();
        nameInput.value = "";
        noteInput.value = "";
        updateSortButtons();
    });

    document.querySelectorAll(".sort-controls button").forEach(btn => {
        btn.addEventListener("click", () => {
            currentSort = btn.dataset.sort;
            updateSortButtons();
            renderInventory();
        });
    });

    const ingredientList = document.getElementById("ingredientList");
    ingredientList.addEventListener("dragstart", (e) => {
        const card = e.target.closest(".ingredient-card");
        if (!card) return;
        draggedIngredientId = card.dataset.id;
        card.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
    });
    ingredientList.addEventListener("dragend", (e) => {
        const card = e.target.closest(".ingredient-card");
        if (card) card.classList.remove("dragging");
        draggedIngredientId = null;
    });
    ingredientList.addEventListener("dragover", (e) => {
        if (!draggedIngredientId) return;
        e.preventDefault();
        const targetCard = e.target.closest(".ingredient-card");
        const container = ingredientList;
        if (!targetCard || targetCard.dataset.id === draggedIngredientId) return;
        const draggedEl = container.querySelector(`[data-id="${draggedIngredientId}"]`);
        if (!draggedEl) return;
        const rect = targetCard.getBoundingClientRect();
        const isAfter = e.clientY > rect.top + rect.height / 2;
        if (isAfter) {
            container.insertBefore(draggedEl, targetCard.nextSibling);
        } else {
            container.insertBefore(draggedEl, targetCard);
        }
    });
}

function setupRecipeActions() {
    document.getElementById("findRecipesBtn").addEventListener("click", () => {
        updateRecipeList();
    });

    document.getElementById("recipeSearch").addEventListener("input", () => {
        updateRecipeList();
    });

    document.getElementById("surpriseBtn").addEventListener("click", () => {
        if (!currentRecipeList.length) {
            alert("No recipes match your current filters yet.");
            return;
        }
        const randomRecipe = currentRecipeList[Math.floor(Math.random() * currentRecipeList.length)];
        openRecipeDetail(randomRecipe.id);
    });

    const mealFilterContainer = document.getElementById("mealTypeFilters");
    mealFilterContainer.addEventListener("click", (e) => {
        if (!e.target.matches("button[data-meal]")) return;
        const value = e.target.dataset.meal;
        if (selectedMealTypes.has(value)) {
            selectedMealTypes.delete(value);
            e.target.classList.remove("active");
        } else {
            selectedMealTypes.add(value);
            e.target.classList.add("active");
        }
        updateRecipeList();
    });

    document.getElementById("customRecipeForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const name = document.getElementById("customRecipeName").value.trim();
        const mealType = document.getElementById("customRecipeMeal").value;
        const tagsRaw = document.getElementById("customRecipeTags").value.trim();
        const extraIngredientsRaw = document.getElementById("customRecipeExtraIngredients").value.trim();
        const instructionsRaw = document.getElementById("customRecipeInstructions").value;
        if (!name || !mealType || !instructionsRaw.trim()) return;

        const ingredientCheckboxes = document.querySelectorAll("#customIngredientOptions input[type='checkbox']");
        const selectedIngredients = [];
        ingredientCheckboxes.forEach(box => {
            if (box.checked) {
                selectedIngredients.push({ name: box.value, amount: "" });
            }
        });

        if (extraIngredientsRaw) {
            extraIngredientsRaw.split(",").map(s => s.trim()).filter(Boolean).forEach(item => {
                selectedIngredients.push({ name: item, amount: "" });
            });
        }

        const instructions = instructionsRaw.split("\n").map(s => s.trim()).filter(Boolean);
        const tags = tagsRaw ? tagsRaw.split(",").map(s => s.trim()).filter(Boolean) : [];

        const recipe = {
            id: generateId("custom"),
            name,
            mealType,
            tags,
            ingredients: selectedIngredients,
            instructions,
            isCustom: true
        };
        customRecipes.push(recipe);
        saveCustomRecipes();
        document.getElementById("customRecipeForm").reset();
        document.querySelectorAll("#customIngredientOptions input[type='checkbox']").forEach(box => box.checked = false);
        showCustomRecipeStatus();
        renderMealPlanner();
        updateRecipeList();
    });

    document.getElementById("closeDetail").addEventListener("click", closeRecipeDetail);
    document.getElementById("recipeDetailOverlay").addEventListener("click", (e) => {
        if (e.target.id === "recipeDetailOverlay") {
            closeRecipeDetail();
        }
    });

    document.getElementById("closeGuided").addEventListener("click", closeGuidedMode);
    document.getElementById("guidedModeOverlay").addEventListener("click", (e) => {
        if (e.target.id === "guidedModeOverlay") {
            closeGuidedMode();
        }
    });

    document.getElementById("prevStep").addEventListener("click", () => {
        if (!guidedModeState) return;
        guidedModeState.stepIndex = Math.max(0, guidedModeState.stepIndex - 1);
        renderGuidedStep();
    });

    document.getElementById("nextStep").addEventListener("click", () => {
        if (!guidedModeState) return;
        guidedModeState.stepIndex = Math.min(guidedModeState.steps.length - 1, guidedModeState.stepIndex + 1);
        renderGuidedStep();
    });
}

function handleQuickAdd(name) {
    const existingIndex = inventory.findIndex(item => item.name.toLowerCase() === name.toLowerCase());
    if (existingIndex !== -1) {
        inventory[existingIndex].available = true;
        inventory[existingIndex].updatedAt = Date.now();
        inventory[existingIndex].useSoon = false;
        inventory[existingIndex].createdAt = Date.now();
        currentSort = "recent";
        persistInventory();
        refreshInventoryUI();
        updateSortButtons();
        return;
    }
    const newIngredient = {
        id: generateId("ing"),
        name,
        note: "",
        available: true,
        useSoon: false,
        createdAt: Date.now(),
        updatedAt: Date.now(),
        expiration: ""
    };
    inventory.unshift(newIngredient);
    currentSort = "recent";
    persistInventory();
    refreshInventoryUI();
    updateSortButtons();
}

function renderInventory() {
    const list = document.getElementById("ingredientList");
    list.innerHTML = "";
    const sorted = [...inventory];
    if (currentSort === "recent") {
        sorted.sort((a, b) => b.createdAt - a.createdAt);
    } else {
        sorted.sort((a, b) => a.name.localeCompare(b.name));
    }
    if (!sorted.length) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = "Add ingredients to start creating personalized recipe ideas.";
        list.appendChild(empty);
        return;
    }
    sorted.forEach(item => {
        const card = document.createElement("article");
        card.className = "ingredient-card";
        if (item.useSoon) card.classList.add("use-soon");
        card.dataset.id = item.id;
        card.draggable = true;
        card.innerHTML = `
            <div class="drag-handle" title="Drag to reorder">&#9776;</div>
            <div class="display-area">
                <div class="ingredient-header">
                    <h3>${item.name}</h3>
                    <span class="badge ${item.available ? "in" : "out"}">${item.available ? "In Fridge" : "Out of Stock"}</span>
                </div>
                <p class="note">${item.note ? item.note : "No quantity noted"}</p>
                <div class="ingredient-actions">
                    <button class="availability-toggle">${item.available ? "Mark Out of Stock" : "Mark In Fridge"}</button>
                    <button class="use-soon-toggle">${item.useSoon ? "Clear Use Soon" : "Mark Use Soon"}</button>
                    <button class="edit-ingredient">Edit</button>
                    <button class="delete-ingredient">Remove</button>
                </div>
            </div>
            <div class="edit-area">
                <input type="text" class="edit-name" value="${item.name}">
                <input type="text" class="edit-note" value="${item.note}">
                <label>Expiration<input type="date" class="edit-expiration" value="${item.expiration || ""}"></label>
                <div class="edit-actions">
                    <button class="save-edit">Save</button>
                    <button class="cancel-edit">Cancel</button>
                </div>
            </div>
        `;
        const toggleBtn = card.querySelector(".availability-toggle");
        toggleBtn.addEventListener("click", () => {
            item.available = !item.available;
            item.updatedAt = Date.now();
            persistInventory();
            refreshInventoryUI();
        });
        const useSoonBtn = card.querySelector(".use-soon-toggle");
        useSoonBtn.addEventListener("click", () => {
            item.useSoon = !item.useSoon;
            item.updatedAt = Date.now();
            persistInventory();
            refreshInventoryUI();
        });
        const deleteBtn = card.querySelector(".delete-ingredient");
        deleteBtn.addEventListener("click", () => {
            inventory = inventory.filter(i => i.id !== item.id);
            persistInventory();
            refreshInventoryUI();
        });
        const editBtn = card.querySelector(".edit-ingredient");
        const cancelBtn = card.querySelector(".cancel-edit");
        const saveBtn = card.querySelector(".save-edit");
        editBtn.addEventListener("click", () => {
            card.classList.add("editing");
        });
        cancelBtn.addEventListener("click", () => {
            card.classList.remove("editing");
        });
        saveBtn.addEventListener("click", () => {
            const newName = card.querySelector(".edit-name").value.trim();
            const newNote = card.querySelector(".edit-note").value.trim();
            const newExpiration = card.querySelector(".edit-expiration").value;
            if (!newName) return;
            item.name = newName;
            item.note = newNote;
            item.expiration = newExpiration;
            item.updatedAt = Date.now();
            card.classList.remove("editing");
            persistInventory();
            refreshInventoryUI();
        });
        list.appendChild(card);
    });
}

function updateInventorySummary() {
    const total = inventory.length;
    const inFridge = inventory.filter(item => item.available).length;
    document.getElementById("totalCount").textContent = total;
    document.getElementById("inFridgeCount").textContent = inFridge;
    document.getElementById("outCount").textContent = total - inFridge;
}

function updateSortButtons() {
    document.querySelectorAll(".sort-controls button").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.sort === currentSort);
    });
}

function refreshInventoryUI() {
    updateInventorySummary();
    renderInventory();
    renderCustomIngredientOptions();
    updateRecipeList();
}

function persistInventory() {
    localStorage.setItem("recipeGenerator_inventory", JSON.stringify(inventory));
}

function loadInventory() {
    try {
        const raw = localStorage.getItem("recipeGenerator_inventory");
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return parsed.map(item => ({
            id: item.id || generateId("ing"),
            name: item.name,
            note: item.note || "",
            available: item.available !== false,
            useSoon: item.useSoon || false,
            createdAt: item.createdAt || Date.now(),
            updatedAt: item.updatedAt || Date.now(),
            expiration: item.expiration || ""
        }));
    } catch {
        return [];
    }
}

function loadFavorites() {
    try {
        const raw = localStorage.getItem("recipeGenerator_favorites");
        if (!raw) return new Set();
        const ids = JSON.parse(raw);
        return new Set(ids);
    } catch {
        return new Set();
    }
}

function saveFavorites() {
    localStorage.setItem("recipeGenerator_favorites", JSON.stringify([...favorites]));
}

function loadCustomRecipes() {
    try {
        const raw = localStorage.getItem("recipeGenerator_customRecipes");
        if (!raw) return [];
        return JSON.parse(raw);
    } catch {
        return [];
    }
}

function saveCustomRecipes() {
    localStorage.setItem("recipeGenerator_customRecipes", JSON.stringify(customRecipes));
}

function loadSubstitutions() {
    try {
        const raw = sessionStorage.getItem("recipeGenerator_substitutions");
        if (!raw) return {};
        return JSON.parse(raw);
    } catch {
        return {};
    }
}

function saveSubstitutions() {
    sessionStorage.setItem("recipeGenerator_substitutions", JSON.stringify(substitutions));
}

function loadShoppingQueue() {
    try {
        const raw = localStorage.getItem("recipeGenerator_shoppingQueue");
        if (!raw) return [];
        return JSON.parse(raw);
    } catch {
        return [];
    }
}

function saveShoppingQueue() {
    localStorage.setItem("recipeGenerator_shoppingQueue", JSON.stringify(shoppingQueue));
}

function renderCustomIngredientOptions() {
    const container = document.getElementById("customIngredientOptions");
    container.innerHTML = "";
    if (!inventory.length) {
        const message = document.createElement("div");
        message.className = "empty-state";
        message.style.padding = "0.75rem";
        message.textContent = "Add items to your fridge to make selection easier.";
        container.appendChild(message);
        return;
    }
    const sorted = [...inventory].sort((a, b) => a.name.localeCompare(b.name));
    sorted.forEach(item => {
        const label = document.createElement("label");
        label.style.display = "flex";
        label.style.alignItems = "center";
        label.style.gap = "0.45rem";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = item.name;
        label.appendChild(checkbox);
        const span = document.createElement("span");
        span.textContent = item.name;
        span.style.fontSize = "0.9rem";
        label.appendChild(span);
        container.appendChild(label);
    });
}

function showCustomRecipeStatus() {
    const status = document.getElementById("customRecipeStatus");
    status.classList.add("visible");
    setTimeout(() => status.classList.remove("visible"), 2000);
}

function getAllRecipes() {
    return [...baseRecipes, ...customRecipes];
}

function computeRecipeMatch(recipe) {
    const availableSet = new Set(inventory.filter(item => item.available).map(item => item.name.toLowerCase()));
    const matching = [];
    const missing = [];
    recipe.ingredients.forEach(ing => {
        const nameLower = ing.name.toLowerCase();
        if (availableSet.has(nameLower)) {
            matching.push(ing);
        } else {
            const substitutionApplied = substitutions[recipe.id]?.[nameLower] || "";
            missing.push({
                ...ing,
                substitutionApplied
            });
        }
    });
    return {
        ...recipe,
        matching,
        missing,
        matchCount: matching.length,
        missingCount: missing.length
    };
}

function updateRecipeList() {
    const dataset = getAllRecipes();
    const computed = dataset.map(recipe => computeRecipeMatch(recipe));
    latestComputedRecipes = computed;
    const searchTerm = document.getElementById("recipeSearch").value.trim().toLowerCase();
    let filtered = computed;
    if (selectedMealTypes.size) {
        filtered = filtered.filter(recipe => selectedMealTypes.has(recipe.mealType));
    }
    if (searchTerm) {
        filtered = filtered.filter(recipe => {
            const nameMatch = recipe.name.toLowerCase().includes(searchTerm);
            const tagMatch = recipe.tags && recipe.tags.some(tag => tag.toLowerCase().includes(searchTerm));
            return nameMatch || tagMatch;
        });
    }
    filtered.sort((a, b) => {
        if (a.missingCount !== b.missingCount) {
            return a.missingCount - b.missingCount;
        }
        if (a.matchCount !== b.matchCount) {
            return b.matchCount - a.matchCount;
        }
        return a.name.localeCompare(b.name);
    });
    currentRecipeList = filtered;
    const recipeList = document.getElementById("recipeList");
    renderRecipeCards(filtered, recipeList);
    renderFavoritesView();
    renderShoppingList();
}

function renderRecipeCards(recipes, container) {
    container.innerHTML = "";
    if (!recipes.length) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = "No recipes to display. Adjust your filters or add more ingredients.";
        container.appendChild(empty);
        return;
    }
    recipes.forEach(recipe => {
        const card = document.createElement("article");
        card.className = "recipe-card";
        card.dataset.id = recipe.id;
        const favoriteActive = favorites.has(recipe.id);
        card.innerHTML = `
            <div class="recipe-header">
                <div>
                    <h3>${recipe.name}</h3>
                    <span class="meal-type">${recipe.mealType}</span>
                </div>
                <button class="favorite-btn" title="Toggle favorite">${favoriteActive ? "★" : "☆"}</button>
            </div>
            <div class="recipe-counts">
                <span>${recipe.matchCount} matching</span>
                <span class="missing">${recipe.missingCount} missing</span>
            </div>
            <div class="ingredients-summary">
                <div>
                    <h4>In Your Fridge</h4>
                    <ul>
                        ${recipe.matching.length ? recipe.matching.map(ing => `<li>${ing.amount ? ing.amount + " " : ""}${ing.name}</li>`).join("") : "<li>No matches yet</li>"}
                    </ul>
                </div>
                <div>
                    <h4>Missing</h4>
                    <ul>
                        ${recipe.missing.length ? recipe.missing.map(ing => {
                            const substitutionText = ing.substitutionApplied ? ` <em>(using ${ing.substitutionApplied})</em>` : "";
                            return `<li class="missing">${ing.amount ? ing.amount + " " : ""}${ing.name}${substitutionText}</li>`;
                        }).join("") : "<li>All ingredients ready!</li>"}
                    </ul>
                </div>
            </div>
            <div class="recipe-actions">
                <button class="detail-btn">View Details</button>
                <button class="shopping-btn">Add to Shopping List</button>
            </div>
        `;
        const favoriteBtn = card.querySelector(".favorite-btn");
        favoriteBtn.addEventListener("click", () => {
            toggleFavorite(recipe.id);
        });
        card.querySelector(".detail-btn").addEventListener("click", () => {
            openRecipeDetail(recipe.id);
        });
        card.querySelector(".shopping-btn").addEventListener("click", () => {
            addRecipeToShopping(recipe.id);
        });
        container.appendChild(card);
    });
}

function toggleFavorite(recipeId) {
    if (favorites.has(recipeId)) {
        favorites.delete(recipeId);
    } else {
        favorites.add(recipeId);
    }
    saveFavorites();
    updateRecipeList();
}

function renderFavoritesView() {
    const container = document.getElementById("favoritesList");
    const favoriteRecipes = latestComputedRecipes.filter(recipe => favorites.has(recipe.id));
    renderRecipeCards(favoriteRecipes, container);
}

function openRecipeDetail(recipeId) {
    const recipe = getAllRecipes().find(r => r.id === recipeId);
    if (!recipe) return;
    currentDetailRecipeId = recipeId;
    const computed = computeRecipeMatch(recipe);
    const overlay = document.getElementById("recipeDetailOverlay");
    const content = document.getElementById("recipeDetailContent");
    content.innerHTML = `
        <button class="close-overlay" id="closeDetail">&times;</button>
        <div class="detail-header">
            <h2>${recipe.name}</h2>
            <span class="meal-type">${recipe.mealType}</span>
        </div>
        <div class="detail-meta">
            <span class="stat">${computed.matchCount} ready</span>
            <span class="stat">${computed.missingCount} missing</span>
            <div class="servings-selector">
                <span>Servings:</span>
                <select id="servingsSelect">
                    ${Array.from({ length: 8 }, (_, i) => `<option value="${i + 1}">${i + 1}</option>`).join("")}
                </select>
            </div>
        </div>
        <div class="detail-ingredients">
            <h3>Ingredients</h3>
            <ul>
                ${recipe.ingredients.map(ing => {
                    const nameLower = ing.name.toLowerCase();
                    const isMissing = !computed.matching.some(match => match.name.toLowerCase() === nameLower);
                    const substitutionApplied = substitutions[recipe.id]?.[nameLower];
                    const substitutionText = substitutionApplied ? ` <em>(using ${substitutionApplied})</em>` : "";
                    return `<li class="${isMissing ? "missing" : ""}">${ing.amount ? ing.amount + " " : ""}${ing.name}${substitutionText}</li>`;
                }).join("")}
            </ul>
            ${computed.missing.length ? computed.missing.map(ing => renderSubstitutionBlock(recipe.id, ing)).join("") : ""}
        </div>
        <div class="detail-instructions">
            <h3>Instructions</h3>
            <ol>
                ${recipe.instructions.map(step => {
                    const durationText = step.duration ? ` <small>(about ${step.duration} min)</small>` : "";
                    return `<li>${step.text}${durationText}</li>`;
                }).join("")}
            </ol>
        </div>
        <div class="detail-actions">
            <button class="guided-btn" id="startGuided">Start Guided Mode</button>
            <button class="shopping-btn" id="detailShoppingBtn">Add to Shopping List</button>
        </div>
    `;
    document.getElementById("startGuided").addEventListener("click", () => startGuidedMode(recipe));
    document.getElementById("detailShoppingBtn").addEventListener("click", () => addRecipeToShopping(recipe.id));
    document.getElementById("closeDetail").addEventListener("click", closeRecipeDetail);
    const selects = content.querySelectorAll(".substitution-select");
    selects.forEach(select => {
        select.addEventListener("change", (e) => {
            const ingredient = e.target.dataset.ingredient;
            const value = e.target.value;
            if (!substitutions[recipe.id]) substitutions[recipe.id] = {};
            substitutions[recipe.id][ingredient.toLowerCase()] = value;
            saveSubstitutions();
            openRecipeDetail(recipe.id);
        });
    });
    overlay.classList.remove("hidden");
    document.body.classList.add("no-scroll");
}

function renderSubstitutionBlock(recipeId, ingredient) {
    const key = ingredient.name.toLowerCase();
    const options = substitutionMap[key] || [];
    if (!options.length) {
        return `
            <div class="substitution-block">
                <strong>${ingredient.name}</strong>
                <span>No substitution suggestions available.</span>
            </div>
        `;
    }
    const applied = substitutions[recipeId]?.[key] || "";
    return `
        <div class="substitution-block">
            <strong>${ingredient.name}</strong>
            <span>Select a substitution to adapt this recipe.</span>
            <select class="substitution-select" data-ingredient="${ingredient.name}">
                <option value="">-- choose substitution --</option>
                ${options.map(opt => `<option value="${opt}" ${opt === applied ? "selected" : ""}>${opt}</option>`).join("")}
            </select>
        </div>
    `;
}

function closeRecipeDetail() {
    document.getElementById("recipeDetailOverlay").classList.add("hidden");
    document.body.classList.remove("no-scroll");
    currentDetailRecipeId = null;
}

function startGuidedMode(recipe) {
    guidedModeState = {
        recipeId: recipe.id,
        recipeName: recipe.name,
        steps: recipe.instructions,
        stepIndex: 0
    };
    renderGuidedStep();
    document.getElementById("recipeDetailOverlay").classList.add("hidden");
    document.getElementById("guidedModeOverlay").classList.remove("hidden");
}

function renderGuidedStep() {
    if (!guidedModeState) return;
    const { recipeName, steps, stepIndex } = guidedModeState;
    document.getElementById("guidedTitle").textContent = recipeName;
    document.getElementById("guidedStepCount").textContent = `Step ${stepIndex + 1} of ${steps.length}`;
    document.getElementById("guidedStepText").textContent = steps[stepIndex].text;
    document.getElementById("prevStep").disabled = stepIndex === 0;
    document.getElementById("nextStep").disabled = stepIndex === steps.length - 1;
}

function closeGuidedMode() {
    document.getElementById("guidedModeOverlay").classList.add("hidden");
    document.body.classList.remove("no-scroll");
    guidedModeState = null;
}

function getNextSevenDays() {
    const days = [];
    const formatter = new Intl.DateTimeFormat(undefined, { weekday: "long", month: "short", day: "numeric" });
    const keyFormatter = new Intl.DateTimeFormat("sv-SE");
    for (let i = 0; i < 7; i++) {
        const date = new Date();
        date.setDate(date.getDate() + i);
        days.push({
            label: formatter.format(date),
            key: keyFormatter.format(date)
        });
    }
    return days;
}

function renderMealPlanner() {
    const container = document.getElementById("mealPlannerGrid");
    container.innerHTML = "";
    const days = getNextSevenDays();
    const recipes = getAllRecipes();
    days.forEach(day => {
        const dayCard = document.createElement("div");
        dayCard.className = "planner-day";
        dayCard.innerHTML = `<h3>${day.label}</h3>`;
        mealSlots.forEach(slot => {
            const slotKey = `${day.key}-${slot}`;
            const slotWrapper = document.createElement("div");
            slotWrapper.className = "meal-slot";
            const label = document.createElement("label");
            label.textContent = slot;
            const select = document.createElement("select");
            select.innerHTML = `<option value="">Select recipe</option>` + recipes.map(r => `<option value="${r.id}">${r.name}</option>`).join("");
            select.value = mealPlannerSelections[slotKey] || "";
            select.addEventListener("change", () => {
                if (select.value) {
                    mealPlannerSelections[slotKey] = select.value;
                } else {
                    delete mealPlannerSelections[slotKey];
                }
            });
            const clearBtn = document.createElement("button");
            clearBtn.type = "button";
            clearBtn.textContent = "Clear";
            clearBtn.addEventListener("click", () => {
                select.value = "";
                delete mealPlannerSelections[slotKey];
            });
            slotWrapper.appendChild(label);
            slotWrapper.appendChild(select);
            slotWrapper.appendChild(clearBtn);
            dayCard.appendChild(slotWrapper);
        });
        container.appendChild(dayCard);
    });
}

function addRecipeToShopping(recipeId) {
    if (!shoppingQueue.includes(recipeId)) {
        shoppingQueue.push(recipeId);
        saveShoppingQueue();
        renderShoppingList();
    }
}

function renderShoppingList() {
    const container = document.getElementById("shoppingListItems");
    container.innerHTML = "";
    if (!shoppingQueue.length) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = "No recipes queued yet. Add a recipe to start planning your shopping.";
        container.appendChild(empty);
        return;
    }
    shoppingQueue.forEach(id => {
        const recipe = getAllRecipes().find(r => r.id === id);
        if (!recipe) return;
        const item = document.createElement("div");
        item.className = "shopping-item";
        item.innerHTML = `
            <span>${recipe.name}</span>
            <button aria-label="Remove from queue">Remove</button>
        `;
        item.querySelector("button").addEventListener("click", () => {
            shoppingQueue = shoppingQueue.filter(rid => rid !== id);
            saveShoppingQueue();
            renderShoppingList();
        });
        container.appendChild(item);
    });
}

function getRecipeById(id) {
    return getAllRecipes().find(recipe => recipe.id === id);
}

function generateId(prefix) {
    return `${prefix}-${Math.random().toString(16).slice(2)}-${Date.now().toString(16)}`;
}
</script>
</body>
</html>