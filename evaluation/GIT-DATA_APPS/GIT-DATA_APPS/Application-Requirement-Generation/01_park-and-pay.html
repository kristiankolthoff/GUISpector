<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Park & Pay</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root {
  --bg: #f4f6fb;
  --surface: #ffffff;
  --primary: #1f6feb;
  --primary-dark: #164c92;
  --accent: #f59e0b;
  --text: #1f2937;
  --muted: #6b7280;
  --border: #e5e7eb;
  --open: #16a34a;
  --filling: #f97316;
  --full: #dc2626;
  --shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
}
* {
  box-sizing: border-box;
}
body {
  margin: 0;
  font-family: "Segoe UI", Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
}
button {
  font-family: inherit;
  cursor: pointer;
}
.app-shell {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}
.top-bar {
  background: var(--surface);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.75rem 2rem;
  border-bottom: 1px solid var(--border);
  box-shadow: var(--shadow);
  position: sticky;
  top: 0;
  z-index: 20;
}
.brand {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}
.brand-icon {
  width: 36px;
  height: 36px;
  border-radius: 12px;
  background: var(--primary);
  display: grid;
  place-items: center;
  color: #fff;
  font-weight: bold;
  letter-spacing: 0.5px;
}
.brand h1 {
  font-size: 1.25rem;
  margin: 0;
}
.main-nav {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.nav-btn {
  border: none;
  background: transparent;
  padding: 0.5rem 1rem;
  border-radius: 999px;
  font-weight: 600;
  color: var(--muted);
  transition: all 0.2s ease;
}
.nav-btn.active {
  background: var(--primary);
  color: #fff;
  box-shadow: 0 10px 20px rgba(31, 111, 235, 0.25);
}
.nav-btn:hover:not(.active) {
  color: var(--primary);
}
main {
  flex: 1;
  padding: 1.5rem 2rem 2.5rem;
}
.section {
  display: none;
  animation: fadeIn 0.3s ease;
}
.section.active {
  display: block;
}
.toolbar {
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: 1rem;
  margin-bottom: 1.5rem;
  align-items: center;
}
.search-form {
  grid-column: span 4;
  display: flex;
  background: var(--surface);
  border-radius: 14px;
  padding: 0.2rem;
  border: 1px solid var(--border);
}
.search-form input {
  flex: 1;
  border: none;
  padding: 0.75rem 0.9rem;
  border-radius: 12px;
  background: transparent;
  font-size: 0.95rem;
  outline: none;
}
.search-form button {
  border: none;
  background: var(--primary);
  color: #fff;
  border-radius: 12px;
  padding: 0 1.1rem;
  font-weight: 600;
}
.price-filter {
  grid-column: span 3;
  background: var(--surface);
  border-radius: 14px;
  padding: 0.9rem 1rem;
  border: 1px solid var(--border);
}
.price-filter h4 {
  margin: 0 0 0.6rem;
  font-size: 0.85rem;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.price-sliders {
  display: flex;
  gap: 0.75rem;
  align-items: center;
}
.price-sliders input[type=range] {
  flex: 1;
  accent-color: var(--primary);
}
.price-display {
  display: flex;
  justify-content: space-between;
  margin-top: 0.65rem;
  font-size: 0.85rem;
  color: var(--muted);
}
.vehicle-filter {
  grid-column: span 3;
  display: flex;
  background: var(--surface);
  border-radius: 14px;
  padding: 0.5rem;
  border: 1px solid var(--border);
  gap: 0.5rem;
}
.vehicle-filter button {
  flex: 1;
  border: none;
  background: transparent;
  padding: 0.6rem 0.4rem;
  border-radius: 10px;
  color: var(--muted);
  font-weight: 600;
  transition: all 0.2s ease;
}
.vehicle-filter button.active {
  background: rgba(31, 111, 235, 0.12);
  color: var(--primary);
}
.sort-control {
  grid-column: span 1;
  background: var(--surface);
  border-radius: 14px;
  border: 1px solid var(--border);
  padding: 0.55rem 0.8rem;
}
.sort-control label {
  display: block;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--muted);
  margin-bottom: 0.35rem;
}
.sort-control select {
  width: 100%;
  border: none;
  background: transparent;
  font-size: 0.95rem;
  outline: none;
}
.view-toggle {
  grid-column: span 1;
  justify-self: end;
}
.view-toggle button {
  border: none;
  background: var(--surface);
  border-radius: 14px;
  padding: 0.75rem 1.2rem;
  font-weight: 600;
  border: 1px solid var(--border);
  transition: all 0.2s ease;
}
.view-toggle button:hover {
  border-color: var(--primary);
  color: var(--primary);
}
.status-legend {
  display: flex;
  gap: 1rem;
  background: var(--surface);
  padding: 0.75rem 1rem;
  border-radius: 14px;
  border: 1px solid var(--border);
  margin-bottom: 1rem;
  width: fit-content;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.85rem;
  color: var(--muted);
}
.legend-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}
.legend-dot.open {
  background: var(--open);
}
.legend-dot.filling {
  background: var(--filling);
}
.legend-dot.full {
  background: var(--full);
}
.home-content {
  display: grid;
  grid-template-columns: 1.1fr 1fr;
  gap: 1.5rem;
  align-items: stretch;
  transition: all 0.3s ease;
}
.home-content.list-only {
  grid-template-columns: 1fr;
}
.home-content.list-only .map-pane {
  display: none;
}
.map-pane,
.list-pane {
  background: var(--surface);
  border-radius: 22px;
  padding: 1.25rem;
  border: 1px solid var(--border);
  position: relative;
}
.map-container {
  position: relative;
  overflow: hidden;
  border-radius: 18px;
  height: 340px;
  background: linear-gradient(135deg, #cfd9f3, #e2ebff);
  border: 1px solid rgba(255, 255, 255, 0.6);
}
.map-surface {
  position: absolute;
  width: 700px;
  height: 450px;
  background-image: radial-gradient(circle at 20% 20%, rgba(31, 111, 235, 0.06) 0, rgba(31, 111, 235, 0.06) 12px, transparent 12px),
                    radial-gradient(circle at 80% 50%, rgba(31, 111, 235, 0.05) 0, rgba(31, 111, 235, 0.05) 10px, transparent 10px);
  background-size: 140px 140px;
  border-radius: 18px;
  transform: translate(0,0);
  transition: transform 0.3s ease;
  cursor: grab;
}
.map-surface.dragging {
  cursor: grabbing;
}
.map-marker {
  position: absolute;
  width: 46px;
  height: 46px;
  border-radius: 16px;
  border: none;
  color: #fff;
  font-weight: 700;
  font-size: 0.8rem;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  box-shadow: var(--shadow);
  transform: translate(-50%, -50%);
  transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
}
.map-marker span {
  font-size: 0.65rem;
  font-weight: 500;
}
.map-marker.status-open {
  background: var(--open);
}
.map-marker.status-filling {
  background: var(--filling);
}
.map-marker.status-full {
  background: var(--full);
}
.map-marker.muted {
  opacity: 0.15;
}
.map-marker.active {
  transform: translate(-50%, -50%) scale(1.12);
  box-shadow: 0 12px 28px rgba(31, 111, 235, 0.25);
}
.map-center-indicator {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 2px solid rgba(31, 111, 235, 0.5);
  transform: translate(-50%, -50%);
  pointer-events: none;
}
.parking-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  max-height: 540px;
  overflow-y: auto;
  padding-right: 0.2rem;
}
.parking-card {
  position: relative;
  border: 1px solid var(--border);
  border-radius: 18px;
  padding: 1.1rem 1.2rem 1.1rem 1.35rem;
  background: #fff;
  display: grid;
  gap: 0.65rem;
  transition: transform 0.2s ease, border-color 0.2s ease;
}
.parking-card:hover {
  transform: translateY(-2px);
  border-color: rgba(31, 111, 235, 0.4);
}
.parking-card.active {
  border-color: var(--primary);
  box-shadow: 0 12px 26px rgba(31, 111, 235, 0.12);
}
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.card-header h4 {
  margin: 0;
  font-size: 1.05rem;
}
.status-badge {
  padding: 0.2rem 0.6rem;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 0.03em;
  text-transform: uppercase;
  color: #fff;
}
.status-open {
  background: var(--open);
}
.status-filling {
  background: var(--filling);
}
.status-full {
  background: var(--full);
}
.card-sub {
  font-size: 0.9rem;
  color: var(--muted);
}
.card-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem 1.5rem;
  font-size: 0.85rem;
  color: var(--text);
}
.card-meta span {
  color: var(--muted);
}
.card-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.tag-row {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.tag {
  background: rgba(31, 111, 235, 0.08);
  color: var(--primary);
  padding: 0.25rem 0.6rem;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 600;
}
.favorite-toggle {
  border: none;
  background: rgba(31, 111, 235, 0.08);
  width: 34px;
  height: 34px;
  border-radius: 50%;
  color: var(--primary);
  display: grid;
  place-items: center;
  font-size: 0.95rem;
  transition: background 0.2s ease, color 0.2s ease;
}
.favorite-toggle.active {
  background: var(--primary);
  color: #fff;
}
.empty-state {
  text-align: center;
  padding: 2.5rem;
  background: rgba(255, 255, 255, 0.7);
  border-radius: 18px;
  border: 1px dashed var(--border);
  color: var(--muted);
}
.detail-panel {
  position: fixed;
  right: 2rem;
  top: 6.5rem;
  width: 340px;
  max-height: calc(100vh - 7.5rem);
  background: var(--surface);
  border-radius: 24px;
  border: 1px solid var(--border);
  box-shadow: 0 18px 45px rgba(15, 23, 42, 0.16);
  display: grid;
  grid-template-rows: auto 1fr;
  overflow: hidden;
  z-index: 15;
  transform: translateX(120%);
  transition: transform 0.3s ease;
}
.detail-panel.visible {
  transform: translateX(0);
}
.detail-header {
  padding: 1.4rem 1.6rem 1.1rem;
  border-bottom: 1px solid var(--border);
  display: grid;
  gap: 0.3rem;
}
.detail-header h3 {
  margin: 0;
  font-size: 1.15rem;
}
.detail-address {
  color: var(--muted);
  font-size: 0.9rem;
}
.detail-body {
  padding: 1.4rem 1.6rem;
  overflow-y: auto;
  display: grid;
  gap: 1.2rem;
}
.meta-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.85rem;
}
.meta-item {
  background: rgba(31, 111, 235, 0.05);
  border-radius: 14px;
  padding: 0.75rem;
}
.meta-item h5 {
  margin: 0 0 0.2rem;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--muted);
}
.meta-item span {
  font-weight: 600;
  font-size: 0.95rem;
}
.vehicle-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.45rem;
}
.vehicle-tags span {
  background: rgba(22, 163, 74, 0.1);
  color: var(--open);
  padding: 0.3rem 0.55rem;
  border-radius: 999px;
  font-weight: 600;
  font-size: 0.78rem;
}
.regulation-card {
  border: 1px solid rgba(31, 111, 235, 0.18);
  border-radius: 16px;
  padding: 0.95rem 1rem;
  background: rgba(31, 111, 235, 0.05);
}
.regulation-card h4 {
  margin: 0 0 0.6rem;
  font-size: 0.9rem;
  letter-spacing: 0.02em;
}
.regulation-card ul {
  margin: 0;
  padding-left: 1.1rem;
  color: var(--muted);
  font-size: 0.88rem;
}
.chart-block {
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 1rem;
}
.chart-block h4 {
  margin: 0 0 0.5rem;
  font-size: 0.95rem;
}
.chart-legend {
  font-size: 0.8rem;
  color: var(--muted);
  margin-bottom: 0.75rem;
}
.chart-bars {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 0.6rem;
  align-items: end;
  height: 140px;
}
.chart-bar {
  background: linear-gradient(180deg, rgba(31, 111, 235, 0.35), rgba(31, 111, 235, 0.9));
  border-radius: 8px 8px 4px 4px;
  position: relative;
}
.chart-bar::after {
  content: attr(data-label);
  position: absolute;
  bottom: -1.4rem;
  left: 50%;
  transform: translateX(-50%);
  font-size: 0.75rem;
  color: var(--muted);
}
.chart-bar::before {
  content: attr(data-value) "%";
  position: absolute;
  top: -1.4rem;
  left: 50%;
  transform: translateX(-50%);
  font-size: 0.7rem;
  color: var(--muted);
}
.panel-actions {
  display: grid;
  gap: 0.6rem;
}
.panel-actions button {
  border: none;
  border-radius: 14px;
  padding: 0.75rem 1rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}
.reserve-action {
  background: var(--primary);
  color: #fff;
}
.directions-action {
  background: rgba(31, 111, 235, 0.12);
  color: var(--primary);
}
.favorite-action {
  background: rgba(22, 163, 74, 0.12);
  color: var(--open);
}
.favorite-action.active {
  background: var(--open);
  color: #fff;
}
.directions-view {
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 0.85rem 1rem;
  background: #f9fafc;
}
.directions-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.directions-header button {
  border: none;
  background: transparent;
  color: var(--primary);
  font-weight: 600;
}
.directions-view ol {
  margin: 0.6rem 0 0;
  padding-left: 1.2rem;
  color: var(--muted);
  font-size: 0.9rem;
}
.close-panel {
  position: absolute;
  top: 0.75rem;
  right: 0.75rem;
  border: none;
  background: rgba(31, 111, 235, 0.08);
  color: var(--primary);
  width: 32px;
  height: 32px;
  border-radius: 50%;
  font-weight: 700;
}
.reservations-wrap,
.favorites-wrap,
.history-wrap,
.vehicle-wrap {
  background: var(--surface);
  border-radius: 24px;
  padding: 2rem;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
}
.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}
.section-header h2 {
  margin: 0;
  font-size: 1.35rem;
}
.active-reservation-card {
  border: 1px solid rgba(31, 111, 235, 0.2);
  border-radius: 20px;
  padding: 1.4rem;
  display: grid;
  gap: 1rem;
  background: linear-gradient(135deg, rgba(31, 111, 235, 0.08), rgba(31, 111, 235, 0.02));
}
.active-reservation-card h3 {
  margin: 0;
  font-size: 1.1rem;
}
.reservation-meta {
  display: grid;
  gap: 0.4rem;
  color: var(--muted);
  font-size: 0.9rem;
}
.countdown {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--primary);
}
.countdown span {
  font-size: 0.8rem;
  color: var(--muted);
  font-weight: 500;
}
.reservation-actions {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}
.reservation-actions button {
  border: none;
  border-radius: 12px;
  padding: 0.65rem 1.1rem;
  font-weight: 600;
}
.cancel-btn {
  background: rgba(220, 38, 38, 0.12);
  color: var(--full);
}
.share-btn {
  background: rgba(31, 111, 235, 0.12);
  color: var(--primary);
}
.favorites-grid,
.history-grid {
  display: grid;
  gap: 1rem;
}
.history-card {
  border: 1px solid var(--border);
  border-radius: 18px;
  padding: 1.2rem 1.3rem;
  background: #fff;
  display: grid;
  gap: 0.75rem;
}
.history-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.history-card-header h4 {
  margin: 0;
}
.history-meta {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(128px, 1fr));
  gap: 0.6rem;
  font-size: 0.85rem;
  color: var(--muted);
}
.clear-history {
  border: none;
  background: rgba(220, 38, 38, 0.12);
  color: var(--full);
  border-radius: 12px;
  padding: 0.6rem 0.9rem;
  font-weight: 600;
}
.vehicle-form {
  display: grid;
  gap: 1rem;
  max-width: 420px;
}
.vehicle-form label {
  display: grid;
  gap: 0.35rem;
  font-weight: 600;
  color: var(--muted);
}
.vehicle-form input,
.vehicle-form select {
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 0.75rem 0.85rem;
  font-size: 0.95rem;
  font-family: inherit;
  background: rgba(246, 248, 255, 0.7);
}
.vehicle-form button {
  border: none;
  background: var(--primary);
  color: #fff;
  border-radius: 12px;
  padding: 0.75rem 1rem;
  font-weight: 600;
  width: fit-content;
}
.vehicle-updated {
  font-size: 0.9rem;
  color: var(--open);
}
.modal {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 30;
}
.modal.visible {
  display: flex;
}
.modal-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(15, 23, 42, 0.45);
  backdrop-filter: blur(4px);
}
.modal-content {
  position: relative;
  background: #fff;
  border-radius: 24px;
  padding: 2rem;
  max-width: 520px;
  width: calc(100% - 2.5rem);
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 28px 55px rgba(15, 23, 42, 0.25);
  animation: scaleIn 0.3s ease;
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.4rem;
}
.modal-header h3 {
  margin: 0;
}
.modal-header button {
  border: none;
  background: rgba(15, 23, 42, 0.08);
  border-radius: 50%;
  width: 34px;
  height: 34px;
  font-weight: 700;
  color: var(--muted);
}
.step-group {
  display: none;
}
.step-group.active {
  display: grid;
  gap: 1.2rem;
}
.form-grid {
  display: grid;
  gap: 1rem;
}
.form-grid label {
  display: grid;
  gap: 0.35rem;
  font-weight: 600;
  color: var(--muted);
  font-size: 0.9rem;
}
.form-grid input,
.form-grid select {
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 0.75rem 0.85rem;
  font-size: 0.95rem;
}
.inline-fields {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1rem;
}
.step-actions {
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
}
.primary-btn {
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 0.75rem 1.4rem;
  font-weight: 600;
}
.secondary-btn {
  background: rgba(31, 111, 235, 0.12);
  color: var(--primary);
  border: none;
  border-radius: 12px;
  padding: 0.75rem 1.2rem;
  font-weight: 600;
}
.summary-card {
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 1rem 1.2rem;
  background: rgba(246, 248, 255, 0.7);
}
.summary-line {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.45rem;
  font-size: 0.92rem;
}
.total-line {
  font-size: 1.05rem;
  font-weight: 700;
}
.validation-error {
  color: var(--full);
  font-size: 0.8rem;
  display: none;
}
.validation-error.visible {
  display: block;
}
.confirmation-view {
  text-align: center;
  display: grid;
  gap: 1rem;
}
.confirmation-view h3 {
  margin: 0;
  font-size: 1.2rem;
}
.confirmation-actions {
  display: flex;
  gap: 0.75rem;
  justify-content: center;
  flex-wrap: wrap;
}
.toast-container {
  position: fixed;
  bottom: 1.5rem;
  right: 1.5rem;
  display: grid;
  gap: 0.5rem;
  z-index: 60;
}
.toast {
  background: #1f2937;
  color: #fff;
  padding: 0.75rem 1rem;
  border-radius: 12px;
  box-shadow: var(--shadow);
  animation: slideUp 0.35s ease, fadeOut 0.4s ease 3s forwards;
}
.tutorial-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 70;
}
.tutorial-overlay.visible {
  display: flex;
}
.tutorial-card {
  background: #fff;
  border-radius: 24px;
  padding: 2rem;
  max-width: 420px;
  text-align: center;
  box-shadow: 0 30px 60px rgba(0,0,0,0.25);
  display: grid;
  gap: 1.2rem;
}
.tutorial-card h2 {
  margin: 0;
}
.tutorial-card p {
  margin: 0;
  color: var(--muted);
}
.tutorial-actions {
  display: flex;
  justify-content: center;
  gap: 0.75rem;
}
.tutorial-actions button {
  border: none;
  border-radius: 999px;
  padding: 0.65rem 1.3rem;
  font-weight: 600;
}
.tutorial-next {
  background: var(--primary);
  color: #fff;
}
.tutorial-skip {
  background: rgba(255,255,255,0.8);
  color: var(--muted);
  border: 1px solid var(--border);
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px);}
  to { opacity: 1; transform: translateY(0);}
}
@keyframes scaleIn {
  from { transform: scale(0.94); opacity: 0;}
  to { transform: scale(1); opacity: 1;}
}
@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0;}
  to { transform: translateY(0); opacity: 1;}
}
@keyframes fadeOut {
  to { opacity: 0;}
}
@media (max-width: 1200px) {
  .toolbar {
    grid-template-columns: repeat(6, 1fr);
  }
  .search-form {
    grid-column: span 6;
  }
  .price-filter {
    grid-column: span 3;
  }
  .vehicle-filter {
    grid-column: span 3;
  }
  .sort-control {
    grid-column: span 3;
  }
  .view-toggle {
    grid-column: span 3;
    justify-self: stretch;
  }
  .home-content {
    grid-template-columns: 1fr;
  }
  .detail-panel {
    display: none;
  }
}
@media (max-width: 768px) {
  main {
    padding: 1.2rem 1.2rem 2rem;
  }
  .top-bar {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }
  .nav-btn {
    padding: 0.45rem 0.85rem;
  }
  .toolbar {
    grid-template-columns: repeat(2, 1fr);
  }
  .price-filter,
  .vehicle-filter,
  .sort-control,
  .view-toggle {
    grid-column: span 2;
  }
  .map-pane,
  .list-pane {
    padding: 1rem;
  }
  .map-container {
    height: 280px;
  }
}
</style>
</head>
<body>
<div class="app-shell">
  <header class="top-bar">
    <div class="brand">
      <div class="brand-icon">P</div>
      <h1>Park & Pay</h1>
    </div>
    <nav class="main-nav">
      <button class="nav-btn active" data-section="discover">Discover</button>
      <button class="nav-btn" data-section="reservations">Reservations</button>
      <button class="nav-btn" data-section="favorites">Favorites</button>
      <button class="nav-btn" data-section="history">History</button>
      <button class="nav-btn" data-section="vehicle">Vehicle</button>
    </nav>
  </header>
  <main>
    <section id="discover" class="section active">
      <div class="toolbar">
        <form class="search-form" id="searchForm">
          <input type="search" id="searchInput" placeholder="Search by address or landmark…" autocomplete="off">
          <button type="submit">Search</button>
        </form>
        <div class="price-filter">
          <h4>Hourly Rate</h4>
          <div class="price-sliders">
            <input type="range" id="priceMin" min="2" max="15" value="2">
            <input type="range" id="priceMax" min="2" max="15" value="15">
          </div>
          <div class="price-display">
            <span id="minLabel">$2</span>
            <span id="maxLabel">$15</span>
          </div>
        </div>
        <div class="vehicle-filter" id="vehicleFilter">
          <button type="button" data-type="All" class="active">All</button>
          <button type="button" data-type="Standard">Standard</button>
          <button type="button" data-type="EV">EV</button>
          <button type="button" data-type="Motorcycle">Motorcycle</button>
        </div>
        <div class="sort-control">
          <label for="sortSelect">Sort by</label>
          <select id="sortSelect">
           _refs
            <option value="recommended">Recommended</option>
            <option value="priceLowHigh">Price: Low to High</option>
            <option value="distanceNearFar">Distance: Near to Far</option>
          </select>
        </div>
        <div class="view-toggle">
          <button id="toggleViewBtn" type="button">Map/List</button>
        </div>
      </div>
      <div class="status-legend">
        <div class="legend-item"><span class="legend-dot open"></span>Open</div>
        <div class="legend-item"><span class="legend-dot filling"></span>Filling</div>
        <div class="legend-item"><span class="legend-dot full"></span>Full</div>
      </div>
      <div class="home-content" id="homeContent">
        <div class="map-pane">
          <h2>City Map</h2>
          <p style="color:var(--muted);font-size:0.9rem;margin-top:0.15rem;">Drag the map or tap a marker to explore parking nearby.</p>
          <div class="map-container">
            <div class="map-surface" id="mapSurface"></div>
            <div class="map-center-indicator"></div>
          </div>
        </div>
        <div class="list-pane">
          <h2>Nearby Parking</h2>
          <div class="parking-list" id="parkingList"></div>
        </div>
      </div>
    </section>

    <section id="reservations" class="section">
      <div class="reservations-wrap">
        <div class="section-header">
          <h2>Reservation Center</h2>
        </div>
        <div id="activeReservationContainer"></div>
      </div>
    </section>

    <section id="favorites" class="section">
      <div class="favorites-wrap">
        <div class="section-header">
          <h2>Saved Favourites</h2>
        </div>
        <div id="favoritesContainer"></div>
      </div>
    </section>

    <section id="history" class="section">
      <div class="history-wrap">
        <div class="section-header">
          <h2>Past Parking</h2>
          <button class="clear-history" id="clearHistoryBtn">Clear History</button>
        </div>
        <div id="historyContainer"></div>
      </div>
    </section>

    <section id="vehicle" class="section">
      <div class="vehicle-wrap">
        <div class="section-header">
          <h2>Primary Vehicle</h2>
        </div>
        <form class="vehicle-form" id="vehicleForm">
          <label>
            Vehicle Nickname
            <input type="text" id="vehicleNickname" placeholder="e.g. City Cruiser">
          </label>
          <label>
            Vehicle Type
            <select id="vehicleType">
              <option value="">Select type</option>
              <option value="Standard">Standard</option>
              <option value="EV">EV</option>
              <option value="Motorcycle">Motorcycle</option>
            </select>
          </label>
          <label>
            License Plate
            <input type="text" id="vehiclePlate" placeholder="ABC-1234">
          </label>
          <button type="submit">Save Vehicle</button>
          <span class="vehicle-updated" id="vehicleUpdatedMessage" style="display:none;">Vehicle profile updated.</span>
        </form>
      </div>
    </section>
  </main>
</div>

<div class="detail-panel" id="detailPanel">
  <button class="close-panel" id="closeDetailBtn">×</button>
  <div class="detail-header">
    <h3 id="detailTitle"></h3>
    <span class="status-badge" id="detailStatus"></span>
    <span class="detail-address" id="detailAddress"></span>
  </div>
  <div class="detail-body">
    <div class="meta-grid">
      <div class="meta-item">
        <h5>Hourly Rate</h5>
        <span id="detailRate"></span>
      </div>
      <div class="meta-item">
        <h5>Walking Distance</h5>
        <span id="detailDistance"></span>
      </div>
      <div class="meta-item">
        <h5>Operating Hours</h5>
        <span id="detailHours"></span>
      </div>
      <div class="meta-item">
        <h5>Max Duration</h5>
        <span id="detailDuration"></span>
      </div>
    </div>
    <div>
      <h4 style="margin:0 0 0.4rem;font-size:0.95rem;">Vehicle Compatibility</h4>
      <div class="vehicle-tags" id="detailVehicles"></div>
    </div>
    <div class="regulation-card">
      <h4>Zone Regulations</h4>
      <ul id="regulationList"></ul>
    </div>
    <div class="chart-block">
      <h4>Occupancy Trend</h4>
      <div class="chart-legend">Blue bars indicate projected occupancy for each 2-hour block.</div>
      <div class="chart-bars" id="occupancyChart"></div>
    </div>
    <div class="panel-actions">
      <button class="reserve-action" id="reserveBtn">Reserve Spot</button>
      <button class="directions-action" id="directionsBtn">Directions</button>
      <button class="favorite-action" id="detailFavoriteBtn">Add to Favourites</button>
    </div>
    <div class="directions-view" id="directionsView" style="display:none;">
      <div class="directions-header">
        <h4 style="margin:0;font-size:0.95rem;">Walking Directions</h4>
        <button type="button" id="closeDirectionsBtn">Back</button>
      </div>
      <ol id="directionsList"></ol>
    </div>
  </div>
</div>

<div class="modal" id="reservationModal">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">Reserve Parking</h3>
      <button type="button" id="closeModalBtn">×</button>
    </div>
    <div class="step-group active" data-step="details">
      <div class="summary-card">
        <strong id="modalSpotName"></strong>
        <div style="font-size:0.9rem;color:var(--muted);" id="modalSpotAddress"></div>
        <div style="margin-top:0.6rem;font-size:0.9rem;">
          Vehicle on file: <span id="modalVehicleSummary">None saved</span>
        </div>
      </div>
      <form class="form-grid" id="reservationForm">
        <label>
          Parking Date
          <input type="date" id="reservationDate" required>
        </label>
        <label>
          Start Time
          <input type="time" id="reservationTime" required>
        </label>
        <label>
          Duration (hours)
          <select id="reservationDuration" required>
            <option value="">Select duration</option>
            <option value="1">1 hour</option>
            <option value="2">2 hours</option>
            <option value="3">3 hours</option>
            <option value="4">4 hours</option>
            <option value="6">6 hours</option>
            <option value="8">8 hours</option>
          </select>
        </label>
        <div class="step-actions">
          <button type="submit" class="primary-btn">Review & Pay</button>
        </div>
      </form>
    </div>
    <div class="step-group" data-step="payment">
      <div class="summary-card">
        <div class="summary-line"><span>Spot</span><span id="paymentSpot"></span></div>
        <div class="summary-line"><span>Date</span><span id="paymentDate"></span></div>
        <div class="summary-line"><span>Start</span><span id="paymentStart"></span></div>
        <div class="summary-line"><span>Duration</span><span id="paymentDuration"></span></div>
        <div class="summary-line"><span>Rate</span><span id="paymentRate"></span></div>
        <div class="summary-line total-line"><span>Total</span><span id="paymentTotal"></span></div>
      </div>
      <div style="display:grid;gap:0.6rem;">
        <label style="display:grid;gap:0.35rem;font-weight:600;color:var(--muted);">
          Promo Code
          <div style="display:flex;gap:0.5rem;">
            <input type="text" id="promoCodeInput" placeholder="Enter code" style="flex:1;">
            <button type="button" class="secondary-btn" id="applyPromoBtn">Apply</button>
          </div>
          <span style="font-size:0.8rem;color:var(--open);display:none;" id="promoSuccess">Promo applied!</span>
        </label>
      </div>
      <form class="form-grid" id="paymentForm" novalidate>
        <label>
          Name on Card
          <input type="text" id="cardName" required>
          <span class="validation-error" id="cardNameError">Please enter the cardholder name.</span>
        </label>
        <label>
          Card Number
          <input type="text" id="cardNumber" inputmode="numeric" placeholder="1234123412341234" required>
          <span class="validation-error" id="cardNumberError">Enter a 16-digit card number.</span>
        </label>
        <div class="inline-fields">
          <label>
            Expiry (MM/YY)
            <input type="text" id="cardExpiry" placeholder="07/27" required>
            <span class="validation-error" id="cardExpiryError">Use MM/YY format.</span>
          </label>
          <label>
            CVV
            <input type="text" id="cardCvv" inputmode="numeric" placeholder="123" required>
            <span class="validation-error" id="cardCvvError">Enter a 3-digit CVV.</span>
          </label>
        </div>
        <div class="step-actions">
          <button type="button" class="secondary-btn" id="backToDetailsBtn">Back</button>
          <button type="submit" class="primary-btn">Confirm Payment</button>
        </div>
      </form>
    </div>
    <div class="step-group" data-step="confirmation">
      <div class="confirmation-view">
        <h3>Reservation Confirmed</h3>
        <p>Your parking pass is set. Manage it anytime from the reservations area.</p>
        <div class="summary-card" style="text-align:left;">
          <div class="summary-line"><span>Spot</span><span id="confirmSpot"></span></div>
          <div class="summary-line"><span>Schedule</span><span id="confirmSchedule"></span></div>
          <div class="summary-line"><span>Duration</span><span id="confirmDuration"></span></div>
          <div class="summary-line total-line"><span>Paid</span><span id="confirmTotal"></span></div>
        </div>
        <div class="confirmation-actions">
          <button class="secondary-btn" id="shareReservationBtn">Share Link</button>
          <button class="secondary-btn" id="downloadReceiptBtn">Download Receipt</button>
        </div>
        <button class="primary-btn" id="closeConfirmationBtn">Done</button>
      </div>
    </div>
  </div>
</div>

<div class="tutorial-overlay" id="tutorialOverlay">
  <div class="tutorial-card">
    <h2 id="tutorialTitle">Welcome to Park & Pay</h2>
    <p id="tutorialMessage"></p>
    <div class="tutorial-actions">
      <button class="tutorial-skip" id="tutorialSkip">Skip</button>
      <button class="tutorial-next" id="tutorialNext">Next</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
const parkingSpots = [
  {
    id: 'P1',
    name: 'Downtown Central Garage',
    address: '120 Market St, Central City',
    landmark: 'City Hall',
    rate: 4.5,
    distance: 0.2,
    status: 'Open',
    coords: { x: 320, y: 180 },
    hours: 'Open 24 hours',
    maxDuration: '6 hours',
    vehicleTypes: ['Standard', 'EV'],
    regulations: {
      duration: 'Stay up to 6 hours per session.',
      permit: 'No residential permit required.',
      enforcement: 'Mon - Sat, 8 a.m. - 8 p.m.'
    },
    occupancy: [35, 45, 60, 70, 55, 30],
    directions: [
      'Exit the transit station toward Market St.',
      'Head east on Market St for two blocks.',
      'Entrance is on the right just past Pine Ave.'
    ]
  },
  {
    id: 'P2',
    name: 'Riverside Lot',
    address: '48 Riverfront Blvd, Central City',
    landmark: 'Riverwalk Park',
    rate: 3.0,
    distance: 0.4,
    status: 'Filling',
    coords: { x: 520, y: 260 },
    hours: '5 a.m. - 1 a.m.',
    maxDuration: '4 hours',
    vehicleTypes: ['Standard', 'Motorcycle'],
    regulations: {
      duration: '4 hour maximum stay.',
      permit: 'Riverfront permit required after 6 p.m.',
      enforcement: 'Daily, 7 a.m. - 10 p.m.'
    },
    occupancy: [40, 55, 72, 78, 60, 42],
    directions: [
      'Walk south toward Riverfront Blvd.',
      'Turn left and continue along the pedestrian path.',
      'Lot entrance is opposite Riverwalk Park Pavilion.'
    ]
  },
  {
    id: 'P3',
    name: 'Midtown EV Hub',
    address: '415 Elm St, Midtown',
    landmark: 'Innovation Center',
    rate: 5.5,
    distance: 0.35,
    status: 'Open',
    coords: { x: 410, y: 120 },
    hours: '6 a.m. - Midnight',
    maxDuration: '8 hours',
    vehicleTypes: ['EV'],
    regulations: {
      duration: 'Charging limited to 8 hours.',
      permit: 'EV parking permit required on weekdays.',
      enforcement: 'Mon - Fri, 7 a.m. - 9 p.m.'
    },
    occupancy: [25, 35, 48, 65, 58, 40],
    directions: [
      'Head north on 4th Ave for one block.',
      'Turn right onto Elm St.',
      'EV Hub entrance is beside Innovation Center.'
    ]
  },
  {
    id: 'P4',
    name: 'Theater District Parking',
    address: '88 Horizon Ave, Arts Quarter',
    landmark: 'Grand Theater',
    rate: 4.0,
    distance: 0.18,
    status: 'Filling',
    coords: { x: 250, y: 260 },
    hours: '24 hours',
    maxDuration: '12 hours',
    vehicleTypes: ['Standard', 'Motorcycle'],
    regulations: {
      duration: '12 hour maximum stay.',
      permit: 'Event permit required during performances.',
      enforcement: 'Daily, 9 a.m. - Midnight.'
    },
    occupancy: [45, 60, 80, 85, 75, 55],
    directions: [
      'Walk west along Horizon Ave.',
      'Cross Maple St at the light.',
      'Ramp entrance is beside Stage Door Café.'
    ]
  },
  {
    id: 'P5',
    name: 'Union Square Underground',
    address: '15 Union Square, Central City',
    landmark: 'Union Square Plaza',
    rate: 6.0,
    distance: 0.3,
    status: 'Full',
    coords: { x: 180, y: 150 },
    hours: '24 hours',
    maxDuration: '10 hours',
    vehicleTypes: ['Standard', 'EV'],
    regulations: {
      duration: '10 hour maximum stay.',
      permit: 'Daily permits required after midnight.',
      enforcement: '24/7 enforcement in effect.'
    },
    occupancy: [60, 75, 90, 95, 90, 80],
    directions: [
      'Head north on Market St.',
      'Enter the plaza and take the escalator down.',
      'Follow signs toward Level B for parking.'
    ]
  },
  {
    id: 'P6',
    name: 'Library Surface Lot',
    address: '601 Oak St, Civic Center',
    landmark: 'City Library',
    rate: 2.5,
    distance: 0.22,
    status: 'Open',
    coords: { x: 480, y: 340 },
    hours: '6 a.m. - 11 p.m.',
    maxDuration: '3 hours',
    vehicleTypes: ['Standard', 'Motorcycle'],
    regulations: {
      duration: '3 hour limit during library hours.',
      permit: 'Library card required for complimentary hour.',
      enforcement: 'Mon - Sat, 7 a.m. - 9 p.m.'
    },
    occupancy: [20, 30, 45, 50, 43, 28],
    directions: [
      'Walk south on Oak St toward the library.',
      'Cross 6th Ave at the crosswalk.',
      'Lot entrance is adjacent to the reading garden.'
    ]
  }
];

const STORAGE_KEYS = {
  favorites: 'parkpay_favorites',
  activeReservation: 'parkpay_activeReservation',
  reservationHistory: 'parkpay_history',
  vehicleProfile: 'parkpay_vehicle',
  tutorial: 'parkpay_tutorial_done'
};

const mapConfig = {
  width: 700,
  height: 450,
  viewportWidth: 420,
  viewportHeight: 320
};

const tutorialSteps = [
  {
    title: 'Welcome to Park & Pay',
    message: 'Discover real-time parking availability with an interactive map and smart filters.'
  },
  {
    title: 'Reserve in Seconds',
    message: 'Select a spot to view details, start a reservation, and secure your space ahead of arrival.'
  },
  {
    title: 'Stay Organized',
    message: 'Track active bookings, manage your vehicle, and revisit past parking history anytime.'
  }
];

const state = {
  filters: {
    searchTerm: '',
    priceMin: 2,
    priceMax: 15,
    vehicleType: 'All',
    sortOption: 'recommended'
  },
  favorites: [],
  selectedSpotId: null,
  mapOffset: { x: 120, y: 80 },
  activeReservation: null,
  reservationHistory: [],
  pendingReservation: null,
  vehicleProfile: null,
  countdownInterval: null,
  tutorialIndex: 0
};

const elements = {
  navButtons: document.querySelectorAll('.nav-btn'),
  sections: document.querySelectorAll('.section'),
  searchForm: document.getElementById('searchForm'),
  searchInput: document.getElementById('searchInput'),
  priceMin: document.getElementById('priceMin'),
  priceMax: document.getElementById('priceMax'),
  minLabel: document.getElementById('minLabel'),
  maxLabel: document.getElementById('maxLabel'),
  vehicleFilter: document.getElementById('vehicleFilter'),
  sortSelect: document.getElementById('sortSelect'),
  toggleViewBtn: document.getElementById('toggleViewBtn'),
  homeContent: document.getElementById('homeContent'),
  parkingList: document.getElementById('parkingList'),
  mapSurface: document.getElementById('mapSurface'),
  detailPanel: document.getElementById('detailPanel'),
  detailTitle: document.getElementById('detailTitle'),
  detailStatus: document.getElementById('detailStatus'),
  detailAddress: document.getElementById('detailAddress'),
  detailRate: document.getElementById('detailRate'),
  detailDistance: document.getElementById('detailDistance'),
  detailHours: document.getElementById('detailHours'),
  detailDuration: document.getElementById('detailDuration'),
  detailVehicles: document.getElementById('detailVehicles'),
  regulationList: document.getElementById('regulationList'),
  occupancyChart: document.getElementById('occupancyChart'),
  reserveBtn: document.getElementById('reserveBtn'),
  directionsBtn: document.getElementById('directionsBtn'),
  detailFavoriteBtn: document.getElementById('detailFavoriteBtn'),
  directionsView: document.getElementById('directionsView'),
  directionsList: document.getElementById('directionsList'),
  closeDirectionsBtn: document.getElementById('closeDirectionsBtn'),
  closeDetailBtn: document.getElementById('closeDetailBtn'),
  reservationModal: document.getElementById('reservationModal'),
  modalTitle: document.getElementById('modalTitle'),
  closeModalBtn: document.getElementById('closeModalBtn'),
  reservationForm: document.getElementById('reservationForm'),
  reservationDate: document.getElementById('reservationDate'),
  reservationTime: document.getElementById('reservationTime'),
  reservationDuration: document.getElementById('reservationDuration'),
  modalSpotName: document.getElementById('modalSpotName'),
  modalSpotAddress: document.getElementById('modalSpotAddress'),
  modalVehicleSummary: document.getElementById('modalVehicleSummary'),
  paymentSpot: document.getElementById('paymentSpot'),
  paymentDate: document.getElementById('paymentDate'),
  paymentStart: document.getElementById('paymentStart'),
  paymentDuration: document.getElementById('paymentDuration'),
  paymentRate: document.getElementById('paymentRate'),
  paymentTotal: document.getElementById('paymentTotal'),
  applyPromoBtn: document.getElementById('applyPromoBtn'),
  promoCodeInput: document.getElementById('promoCodeInput'),
  promoSuccess: document.getElementById('promoSuccess'),
  paymentForm: document.getElementById('paymentForm'),
  cardName: document.getElementById('cardName'),
  cardNumber: document.getElementById('cardNumber'),
  cardExpiry: document.getElementById('cardExpiry'),
  cardCvv: document.getElementById('cardCvv'),
  cardNameError: document.getElementById('cardNameError'),
  cardNumberError: document.getElementById('cardNumberError'),
  cardExpiryError: document.getElementById('cardExpiryError'),
  cardCvvError: document.getElementById('cardCvvError'),
  backToDetailsBtn: document.getElementById('backToDetailsBtn'),
  closeConfirmationBtn: document.getElementById('closeConfirmationBtn'),
  confirmSpot: document.getElementById('confirmSpot'),
  confirmSchedule: document.getElementById('confirmSchedule'),
  confirmDuration: document.getElementById('confirmDuration'),
  confirmTotal: document.getElementById('confirmTotal'),
  shareReservationBtn: document.getElementById('shareReservationBtn'),
  downloadReceiptBtn: document.getElementById('downloadReceiptBtn'),
  activeReservationContainer: document.getElementById('activeReservationContainer'),
  favoritesContainer: document.getElementById('favoritesContainer'),
  historyContainer: document.getElementById('historyContainer'),
  clearHistoryBtn: document.getElementById('clearHistoryBtn'),
  vehicleForm: document.getElementById('vehicleForm'),
  vehicleNickname: document.getElementById('vehicleNickname'),
  vehicleType: document.getElementById('vehicleType'),
  vehiclePlate: document.getElementById('vehiclePlate'),
  vehicleUpdatedMessage: document.getElementById('vehicleUpdatedMessage'),
  tutorialOverlay: document.getElementById('tutorialOverlay'),
  tutorialTitle: document.getElementById('tutorialTitle'),
  tutorialMessage: document.getElementById('tutorialMessage'),
  tutorialNext: document.getElementById('tutorialNext'),
  tutorialSkip: document.getElementById('tutorialSkip'),
  toastContainer: document.getElementById('toastContainer')
};

function init() {
  loadFromStorage();
  renderMapMarkers();
  applyFilters();
  bindEvents();
  updateActiveReservationUI();
  renderFavorites();
  renderHistory();
  populateVehicleForm();
  setupTutorial();
}

function loadFromStorage() {
  try {
    const favorites = JSON.parse(localStorage.getItem(STORAGE_KEYS.favorites)) || [];
    const activeReservation = JSON.parse(localStorage.getItem(STORAGE_KEYS.activeReservation));
    const history = JSON.parse(localStorage.getItem(STORAGE_KEYS.reservationHistory)) || [];
    const vehicle = JSON.parse(localStorage.getItem(STORAGE_KEYS.vehicleProfile));
    state.favorites = favorites;
    state.activeReservation = activeReservation;
    state.reservationHistory = history;
    state.vehicleProfile = vehicle;
    if (activeReservation) {
      startCountdown();
    }
  } catch (e) {
    console.error('Storage load error', e);
  }
}

function bindEvents() {
  elements.navButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      elements.navButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset.section;
      elements.sections.forEach(section => {
        section.classList.toggle('active', section.id === target);
      });
    });
  });

  elements.searchForm.addEventListener('submit', handleSearch);
  elements.priceMin.addEventListener('input', handlePriceSlider);
  elements.priceMax.addEventListener('input', handlePriceSlider);
  elements.vehicleFilter.addEventListener('click', handleVehicleFilter);
  elements.sortSelect.addEventListener('change', handleSortChange);
  elements.toggleViewBtn.addEventListener('click', toggleHomeView);
  elements.parkingList.addEventListener('click', handleListClick);
  elements.mapSurface.addEventListener('pointerdown', handleMapPointerDown);
  elements.reserveBtn.addEventListener('click', openReservationModal);
  elements.closeDetailBtn.addEventListener('click', hideDetailPanel);
  elements.directionsBtn.addEventListener('click', showDirections);
  elements.closeDirectionsBtn.addEventListener('click', hideDirections);
  elements.detailFavoriteBtn.addEventListener('click', toggleFavoriteFromDetail);
  elements.closeModalBtn.addEventListener('click', closeReservationModal);
  elements.reservationModal.addEventListener('click', event => {
    if (event.target === elements.reservationModal) {
      closeReservationModal();
    }
  });
  elements.reservationForm.addEventListener('submit', handleReservationDetailsSubmit);
  elements.backToDetailsBtn.addEventListener('click', () => switchModalStep('details'));
  elements.paymentForm.addEventListener('submit', handlePaymentSubmit);
  elements.closeConfirmationBtn.addEventListener('click', () => {
    closeReservationModal();
  });
  elements.shareReservationBtn.addEventListener('click', shareReservationLink);
  elements.downloadReceiptBtn.addEventListener('click', () => {
    showToast('Receipts will be available soon.');
  });
  elements.activeReservationContainer.addEventListener('click', handleReservationActions);
  elements.favoritesContainer.addEventListener('click', handleFavoritesSection);
  elements.historyContainer.addEventListener('click', handleHistorySection);
  elements.clearHistoryBtn.addEventListener('click', clearHistory);
  elements.vehicleForm.addEventListener('submit', saveVehicleProfile);
  elements.applyPromoBtn.addEventListener('click', applyPromoCode);
  elements.tutorialNext.addEventListener('click', advanceTutorial);
  elements.tutorialSkip.addEventListener('click', completeTutorial);
}

function handleSearch(event) {
  event.preventDefault();
  const term = elements.searchInput.value.trim();
  if (term.length < 3) {
    showToast('Please enter at least three characters to search.');
    return;
  }
  state.filters.searchTerm = term;
  applyFilters(true);
}

function handlePriceSlider() {
  let minValue = parseInt(elements.priceMin.value, 10);
  let maxValue = parseInt(elements.priceMax.value, 10);
  if (minValue > maxValue) {
    if (event.target === elements.priceMin) {
      maxValue = minValue;
      elements.priceMax.value = maxValue;
    } else {
      minValue = maxValue;
      elements.priceMin.value = minValue;
    }
  }
  state.filters.priceMin = minValue;
  state.filters.priceMax = maxValue;
  elements.minLabel.textContent = `$${minValue}`;
  elements.maxLabel.textContent = `$${maxValue}`;
  applyFilters();
}

function handleVehicleFilter(event) {
  if (event.target.matches('button')) {
    const type = event.target.dataset.type;
    state.filters.vehicleType = type;
    elements.vehicleFilter.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    applyFilters();
  }
}

function handleSortChange() {
  state.filters.sortOption = elements.sortSelect.value;
  applyFilters();
}

function toggleHomeView() {
  elements.homeContent.classList.toggle('list-only');
}

function renderMapMarkers() {
  elements.mapSurface.innerHTML = '';
  parkingSpots.forEach(spot => {
    const marker = document.createElement('button');
    marker.className = `map-marker status-${spot.status.toLowerCase()}`;
    marker.dataset.id = spot.id;
    marker.style.left = `${spot.coords.x}px`;
    marker.style.top = `${spot.coords.y}px`;
    marker.innerHTML = `<div>${spot.name.split(' ')[0]}</div><span>${spot.rate.toFixed(2)}</span>`;
    marker.addEventListener('click', () => selectSpot(spot.id));
    elements.mapSurface.appendChild(marker);
  });
  updateMapTransform();
}

function applyFilters(fromSearch = false) {
  let filtered = parkingSpots.filter(spot => {
    const matchesPrice = spot.rate >= state.filters.priceMin && spot.rate <= state.filters.priceMax;
    const matchesVehicle = state.filters.vehicleType === 'All' || spot.vehicleTypes.includes(state.filters.vehicleType);
    let matchesSearch = true;
    if (state.filters.searchTerm && state.filters.searchTerm.length >= 3) {
      const term = state.filters.searchTerm.toLowerCase();
      matchesSearch = spot.address.toLowerCase().includes(term) || spot.landmark.toLowerCase().includes(term) || spot.name.toLowerCase().includes(term);
    }
    return matchesPrice && matchesVehicle && matchesSearch;
  });

  if (state.filters.sortOption === 'priceLowHigh') {
    filtered.sort((a, b) => a.rate - b.rate);
  } else if (state.filters.sortOption === 'distanceNearFar') {
    filtered.sort((a, b) => a.distance - b.distance);
  } else {
    filtered.sort((a, b) => (state.favorites.includes(b.id) - state.favorites.includes(a.id)) || a.distance - b.distance);
  }

  renderParkingList(filtered);
  updateMapMarkers(filtered);

  if (fromSearch && filtered.length > 0) {
    centerMapOnSpot(filtered[0]);
    selectSpot(filtered[0].id);
  }
}

function renderParkingList(spots) {
  elements.parkingList.innerHTML = '';
  if (spots.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'empty-state';
    empty.textContent = 'No parking spots match your filters right now.';
    elements.parkingList.appendChild(empty);
    return;
  }
  spots.forEach(spot => {
    const card = document.createElement('div');
    card.className = 'parking-card';
    card.dataset.id = spot.id;
    if (state.selectedSpotId === spot.id) {
      card.classList.add('active');
    }
    card.innerHTML = `
      <div class="card-header">
        <h4>${spot.name}</h4>
        <span class="status-badge status-${spot.status.toLowerCase()}">${spot.status}</span>
      </div>
      <div class="card-sub">${spot.address} • ${spot.distance.toFixed(2)} mi walk</div>
      <div class="card-meta">
        <div><strong>$${spot.rate.toFixed(2)}</strong><span>/hr</span></div>
        <div>Max ${spot.maxDuration}</div>
        <div>Landmark: ${spot.landmark}</div>
      </div>
      <div class="card-footer">
        <div class="tag-row">
          ${spot.vehicleTypes.map(type => `<span class="tag">${type}</span>`).join('')}
        </div>
        <button class="favorite-toggle ${state.favorites.includes(spot.id) ? 'active' : ''}" data-id="${spot.id}" aria-label="Toggle favourite">★</button>
      </div>
    `;
    elements.parkingList.appendChild(card);
  });
}

function updateMapMarkers(filteredSpots) {
  const markerElements = elements.mapSurface.querySelectorAll('.map-marker');
  const visibleIds = filteredSpots.map(spot => spot.id);
  markerElements.forEach(marker => {
    if (visibleIds.includes(marker.dataset.id)) {
      marker.classList.remove('muted');
    } else {
      marker.classList.add('muted');
    }
    marker.classList.toggle('active', marker.dataset.id === state.selectedSpotId);
  });
}

function selectSpot(spotId) {
  const spot = parkingSpots.find(s => s.id === spotId);
  if (!spot) return;
  state.selectedSpotId = spotId;
  document.querySelectorAll('.parking-card').forEach(card => {
    card.classList.toggle('active', card.dataset.id === spotId);
  });
  centerMapOnSpot(spot);
  updateMapMarkers(applyFilterSnapshot());
  populateDetailPanel(spot);
}

function applyFilterSnapshot() {
  return parkingSpots.filter(spot => {
    const matchesPrice = spot.rate >= state.filters.priceMin && spot.rate <= state.filters.priceMax;
    const matchesVehicle = state.filters.vehicleType === 'All' || spot.vehicleTypes.includes(state.filters.vehicleType);
    let matchesSearch = true;
    if (state.filters.searchTerm && state.filters.searchTerm.length >= 3) {
      const term = state.filters.searchTerm.toLowerCase();
      matchesSearch = spot.address.toLowerCase().includes(term) || spot.landmark.toLowerCase().includes(term) || spot.name.toLowerCase().includes(term);
    }
    return matchesPrice && matchesVehicle && matchesSearch;
  });
}

function centerMapOnSpot(spot) {
  const viewportWidth = mapConfig.viewportWidth;
  const viewportHeight = mapConfig.viewportHeight;
  let targetX = spot.coords.x - viewportWidth / 2;
  let targetY = spot.coords.y - viewportHeight / 2;
  targetX = clamp(targetX, 0, mapConfig.width - viewportWidth);
  targetY = clamp(targetY, 0, mapConfig.height - viewportHeight);
  state.mapOffset.x = targetX;
  state.mapOffset.y = targetY;
  updateMapTransform(true);
}

function updateMapTransform(animated = false) {
  if (!animated) {
    elements.mapSurface.style.transition = 'transform 0.3s ease';
  }
  elements.mapSurface.style.transform = `translate(${-state.mapOffset.x}px, ${-state.mapOffset.y}px)`;
  setTimeout(() => {
    elements.mapSurface.style.transition = '';
  }, 320);
}

function populateDetailPanel(spot) {
  elements.detailTitle.textContent = spot.name;
  elements.detailStatus.textContent = spot.status;
  elements.detailStatus.className = `status-badge status-${spot.status.toLowerCase()}`;
  elements.detailAddress.textContent = `${spot.address} • ${spot.landmark}`;
  elements.detailRate.textContent = `$${spot.rate.toFixed(2)}/hr`;
  elements.detailDistance.textContent = `${spot.distance.toFixed(2)} miles`;
  elements.detailHours.textContent = spot.hours;
  elements.detailDuration.textContent = spot.maxDuration;
  elements.detailVehicles.innerHTML = spot.vehicleTypes.map(v => `<span>${v}</span>`).join('');
  elements.regulationList.innerHTML = `
    <li>${spot.regulations.duration}</li>
    <li>${spot.regulations.permit}</li>
    <li>${spot.regulations.enforcement}</li>
  `;
  renderOccupancyChart(spot);
  renderDirections(spot);
  elements.detailFavoriteBtn.textContent = state.favorites.includes(spot.id) ? 'Remove from Favourites' : 'Add to Favourites';
  elements.detailFavoriteBtn.classList.toggle('active', state.favorites.includes(spot.id));
  elements.directionsView.style.display = 'none';
  elements.detailPanel.classList.add('visible');
}

function renderOccupancyChart(spot) {
  elements.occupancyChart.innerHTML = '';
  const labels = ['6a', '8a', '10a', '12p', '2p', '4p'];
  spot.occupancy.forEach((value, idx) => {
    const bar = document.createElement('div');
    bar.className = 'chart-bar';
    bar.style.height = `${clamp(value, 0, 100)}%`;
    bar.dataset.value = value;
    bar.dataset.label = labels[idx];
    elements.occupancyChart.appendChild(bar);
  });
}

function renderDirections(spot) {
  elements.directionsList.innerHTML = '';
  spot.directions.forEach(step => {
    const li = document.createElement('li');
    li.textContent = step;
    elements.directionsList.appendChild(li);
  });
}

function hideDetailPanel() {
  elements.detailPanel.classList.remove('visible');
  state.selectedSpotId = null;
  document.querySelectorAll('.parking-card').forEach(card => card.classList.remove('active'));
  updateMapMarkers(applyFilterSnapshot());
}

function showDirections() {
  elements.directionsView.style.display = 'block';
}

function hideDirections() {
  elements.directionsView.style.display = 'none';
}

let mapDragStart = null;
function handleMapPointerDown(event) {
  mapDragStart = {
    pointerX: event.clientX,
    pointerY: event.clientY,
    offsetX: state.mapOffset.x,
    offsetY: state.mapOffset.y
  };
  elements.mapSurface.classList.add('dragging');
  window.addEventListener('pointermove', handleMapPointerMove);
  window.addEventListener('pointerup', handleMapPointerUp);
}

function handleMapPointerMove(event) {
  if (!mapDragStart) return;
  const deltaX = event.clientX - mapDragStart.pointerX;
  const deltaY = event.clientY - mapDragStart.pointerY;
  let newX = mapDragStart.offsetX - deltaX;
  let newY = mapDragStart.offsetY - deltaY;
  newX = clamp(newX, 0, mapConfig.width - mapConfig.viewportWidth);
  newY = clamp(newY, 0, mapConfig.height - mapConfig.viewportHeight);
  state.mapOffset.x = newX;
  state.mapOffset.y = newY;
  elements.mapSurface.style.transition = 'none';
  elements.mapSurface.style.transform = `translate(${-newX}px, ${-newY}px)`;
}

function handleMapPointerUp() {
  elements.mapSurface.classList.remove('dragging');
  window.removeEventListener('pointermove', handleMapPointerMove);
  window.removeEventListener('pointerup', handleMapPointerUp);
  mapDragStart = null;
}

function handleListClick(event) {
  const favoriteBtn = event.target.closest('.favorite-toggle');
  if (favoriteBtn) {
    const id = favoriteBtn.dataset.id;
    toggleFavorite(id);
    favoriteBtn.classList.toggle('active', state.favorites.includes(id));
    updateMapMarkers(applyFilterSnapshot());
    renderFavorites();
    return;
  }
  const card = event.target.closest('.parking-card');
  if (card) {
    selectSpot(card.dataset.id);
  }
}

function toggleFavorite(id) {
  if (state.favorites.includes(id)) {
    state.favorites = state.favorites.filter(f => f !== id);
  } else {
    state.favorites.push(id);
  }
  localStorage.setItem(STORAGE_KEYS.favorites, JSON.stringify(state.favorites));
  applyFilters();
  renderFavorites();
}

function toggleFavoriteFromDetail() {
  if (!state.selectedSpotId) return;
  toggleFavorite(state.selectedSpotId);
  const isFavorite = state.favorites.includes(state.selectedSpotId);
  elements.detailFavoriteBtn.textContent = isFavorite ? 'Remove from Favourites' : 'Add to Favourites';
  elements.detailFavoriteBtn.classList.toggle('active', isFavorite);
}

function openReservationModal() {
  if (!state.selectedSpotId) {
    showToast('Select a parking location to start a reservation.');
    return;
  }
  const spot = parkingSpots.find(s => s.id === state.selectedSpotId);
  if (!spot) return;
  state.pendingReservation = null;
  setModalStep('details');
  elements.modalTitle.textContent = `Reserve ${spot.name}`;
  elements.modalSpotName.textContent = spot.name;
  elements.modalSpotAddress.textContent = spot.address;
  elements.modalVehicleSummary.textContent = state.vehicleProfile ? `${state.vehicleProfile.nickname || 'Primary vehicle'} (${state.vehicleProfile.type}) • ${state.vehicleProfile.plate}` : 'No vehicle saved';
  const today = new Date();
  const minDate = today.toISOString().split('T')[0];
  const maxDate = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
  elements.reservationDate.min = minDate;
  elements.reservationDate.max = maxDate;
  elements.reservationDate.value = minDate;
  const defaultTime = new Date(today.getTime() + 45 * 60000);
  const hours = String(defaultTime.getHours()).padStart(2, '0');
  const minutes = String(defaultTime.getMinutes()).padStart(2, '0');
  elements.reservationTime.value = `${hours}:${minutes}`;
  elements.reservationDuration.value = '';
  elements.promoCodeInput.value = '';
  elements.promoSuccess.style.display = 'none';
  elements.cardName.value = state.vehicleProfile ? state.vehicleProfile.nickname : '';
  elements.cardNumber.value = '';
  elements.cardExpiry.value = '';
  elements.cardCvv.value = '';
  elements.reservationModal.classList.add('visible');
}

function closeReservationModal() {
  elements.reservationModal.classList.remove('visible');
}

function setModalStep(step) {
  document.querySelectorAll('.step-group').forEach(group => {
    group.classList.toggle('active', group.dataset.step === step);
  });
}

function switchModalStep(step) {
  setModalStep(step);
}

function handleReservationDetailsSubmit(event) {
  event.preventDefault();
  const spot = parkingSpots.find(s => s.id === state.selectedSpotId);
  if (!spot) return;
  const date = elements.reservationDate.value;
  const time = elements.reservationTime.value;
  const duration = parseInt(elements.reservationDuration.value, 10);
  if (!date || !time || !duration) {
    showToast('Please complete all reservation details.');
    return;
  }
  state.pendingReservation = {
    spotId: spot.id,
    spotName: spot.name,
    spotAddress: spot.address,
    rate: spot.rate,
    date,
    time,
    duration,
    total: parseFloat((duration * spot.rate).toFixed(2)),
    discount: 0
  };
  elements.paymentSpot.textContent = spot.name;
  elements.paymentDate.textContent = formatDateForDisplay(date);
  elements.paymentStart.textContent = time;
  elements.paymentDuration.textContent = `${duration} hour${duration > 1 ? 's' : ''}`;
  elements.paymentRate.textContent = `$${spot.rate.toFixed(2)}/hr`;
  elements.paymentTotal.textContent = `$${state.pendingReservation.total.toFixed(2)}`;
  elements.promoSuccess.style.display = 'none';
  switchModalStep('payment');
}

function handlePaymentSubmit(event) {
  event.preventDefault();
  if (!state.pendingReservation) return;
  const name = elements.cardName.value.trim();
  const number = elements.cardNumber.value.trim();
  const expiry = elements.cardExpiry.value.trim();
  const cvv = elements.cardCvv.value.trim();

  let valid = true;

  if (!name) {
    elements.cardNameError.classList.add('visible');
    valid = false;
  } else {
    elements.cardNameError.classList.remove('visible');
  }

  if (!/^\d{16}$/.test(number)) {
    elements.cardNumberError.classList.add('visible');
    valid = false;
  } else {
    elements.cardNumberError.classList.remove('visible');
  }

  if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiry)) {
    elements.cardExpiryError.classList.add('visible');
    valid = false;
  } else {
    elements.cardExpiryError.classList.remove('visible');
  }

  if (!/^\d{3}$/.test(cvv)) {
    elements.cardCvvError.classList.add('visible');
    valid = false;
  } else {
    elements.cardCvvError.classList.remove('visible');
  }

  if (!valid) {
    return;
  }

  completeReservation();
}

function completeReservation() {
  const pending = state.pendingReservation;
  if (!pending) return;
  const reservationId = `res-${Date.now()}`;
  const totalPaid = pending.total - pending.discount;
  const reservationRecord = {
    id: reservationId,
    spotId: pending.spotId,
    spotName: pending.spotName,
    address: pending.spotAddress,
    date: pending.date,
    startTime: pending.time,
    duration: pending.duration,
    rate: pending.rate,
    totalPaid: parseFloat(totalPaid.toFixed(2)),
    createdAt: new Date().toISOString()
  };
  state.activeReservation = reservationRecord;
  localStorage.setItem(STORAGE_KEYS.activeReservation, JSON.stringify(reservationRecord));
  state.reservationHistory.unshift(reservationRecord);
  localStorage.setItem(STORAGE_KEYS.reservationHistory, JSON.stringify(state.reservationHistory));
  updateActiveReservationUI();
  renderHistory();
  startCountdown();
  elements.confirmSpot.textContent = pending.spotName;
  elements.confirmSchedule.textContent = `${formatDateForDisplay(pending.date)} @ ${pending.time}`;
  elements.confirmDuration.textContent = `${pending.duration} hour${pending.duration > 1 ? 's' : ''}`;
  elements.confirmTotal.textContent = `$${totalPaid.toFixed(2)}`;
  switchModalStep('confirmation');
}

function updateActiveReservationUI() {
  elements.activeReservationContainer.innerHTML = '';
  if (!state.activeReservation) {
    const empty = document.createElement('div');
    empty.className = 'empty-state';
    empty.textContent = 'No active reservation yet. Select a parking spot to secure your next visit.';
    elements.activeReservationContainer.appendChild(empty);
    stopCountdown();
    return;
  }
  const reservation = state.activeReservation;
  const card = document.createElement('div');
  card.className = 'active-reservation-card';
  card.innerHTML = `
    <div>
      <h3>${reservation.spotName}</h3>
      <div class="reservation-meta">
        <span>${reservation.address}</span>
        <span>${formatDateForDisplay(reservation.date)} @ ${reservation.startTime}</span>
        <span>${reservation.duration} hour${reservation.duration > 1 ? 's' : ''} • $${reservation.totalPaid.toFixed(2)}</span>
      </div>
    </div>
    <div class="countdown">
      <div id="countdownTimer">--:--</div>
      <span>until start</span>
    </div>
    <div class="reservation-actions">
      <button class="share-btn" data-action="share">Share</button>
      <button class="cancel-btn" data-action="cancel">Cancel</button>
    </div>
  `;
  elements.activeReservationContainer.appendChild(card);
  updateCountdownDisplay();
}

function startCountdown() {
  stopCountdown();
  if (!state.activeReservation) return;
  state.countdownInterval = setInterval(updateCountdownDisplay, 1000);
  updateCountdownDisplay();
}

function stopCountdown() {
  if (state.countdownInterval) {
    clearInterval(state.countdownInterval);
    state.countdownInterval = null;
  }
}

function updateCountdownDisplay() {
  if (!state.activeReservation) return;
  const countdownEl = document.getElementById('countdownTimer');
  if (!countdownEl) return;
  const now = new Date();
  const target = new Date(`${state.activeReservation.date}T${state.activeReservation.startTime}`);
  const diff = target - now;
  if (diff <= 0) {
    countdownEl.textContent = '00:00';
    stopCountdown();
    return;
  }
  const minutes = Math.floor(diff / 60000);
  const seconds = Math.floor((diff % 60000) / 1000);
  countdownEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

function handleReservationActions(event) {
  const action = event.target.dataset.action;
  if (!action) return;
  if (action === 'cancel') {
    if (confirm('Cancel this reservation?')) {
      cancelReservation();
    }
  } else if (action === 'share') {
    shareReservationLink();
  }
}

function cancelReservation() {
  state.activeReservation = null;
  localStorage.removeItem(STORAGE_KEYS.activeReservation);
  updateActiveReservationUI();
  showToast('Reservation cancelled.');
}

function renderFavorites() {
  elements.favoritesContainer.innerHTML = '';
  if (state.favorites.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'empty-state';
    empty.textContent = 'Save parking spots you love for quick access next time.';
    elements.favoritesContainer.appendChild(empty);
    return;
  }
  const grid = document.createElement('div');
  grid.className = 'favorites-grid';
  state.favorites.map(id => parkingSpots.find(spot => spot.id === id)).filter(Boolean).forEach(spot => {
    const card = document.createElement('div');
    card.className = 'parking-card';
    card.dataset.id = spot.id;
    card.innerHTML = `
      <div class="card-header">
        <h4>${spot.name}</h4>
        <span class="status-badge status-${spot.status.toLowerCase()}">${spot.status}</span>
      </div>
      <div class="card-sub">${spot.address}</div>
      <div class="card-meta">
        <div><strong>$${spot.rate.toFixed(2)}</strong><span>/hr</span></div>
        <div>${spot.distance.toFixed(2)} mi walk</div>
      </div>
      <div class="card-footer">
        <div class="tag-row">${spot.vehicleTypes.map(type => `<span class="tag">${type}</span>`).join('')}</div>
        <button class="favorite-toggle active" data-id="${spot.id}">★</button>
      </div>
    `;
    grid.appendChild(card);
  });
  elements.favoritesContainer.appendChild(grid);
}

function handleFavoritesSection(event) {
  const toggle = event.target.closest('.favorite-toggle');
  if (toggle) {
    const id = toggle.dataset.id;
    toggleFavorite(id);
    renderFavorites();
  }
  const card = event.target.closest('.parking-card');
  if (card) {
    const id = card.dataset.id;
    const spot = parkingSpots.find(s => s.id === id);
    document.querySelector('[data-section="discover"]').click();
    state.selectedSpotId = id;
    populateDetailPanel(spot);
    centerMapOnSpot(spot);
  }
}

function renderHistory() {
  elements.historyContainer.innerHTML = '';
  if (state.reservationHistory.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'empty-state';
    empty.textContent = 'Completed reservations will appear here for quick reference.';
    elements.historyContainer.appendChild(empty);
    return;
  }
  const grid = document.createElement('div');
  grid.className = 'history-grid';
  state.reservationHistory.forEach(record => {
    const card = document.createElement('div');
    card.className = 'history-card';
    card.innerHTML = `
      <div class="history-card-header">
        <h4>${record.spotName}</h4>
        <strong>$${record.totalPaid.toFixed(2)}</strong>
      </div>
      <div class="history-meta">
        <span>Date: ${formatDateForDisplay(record.date)}</span>
        <span>Start: ${record.startTime}</span>
        <span>Duration: ${record.duration} hr</span>
        <span>Reference: ${record.id.slice(-6)}</span>
      </div>
    `;
    grid.appendChild(card);
  });
  elements.historyContainer.appendChild(grid);
}

function handleHistorySection(event) {
  const card = event.target.closest('.history-card');
  if (card) {
    showToast('Detailed receipts will be available soon.');
  }
}

function clearHistory() {
  if (!state.reservationHistory.length) {
    showToast('History is already clear.');
    return;
  }
  if (confirm('Remove all past reservations from history?')) {
    state.reservationHistory = [];
    localStorage.setItem(STORAGE_KEYS.reservationHistory, JSON.stringify([]));
    renderHistory();
    showToast('History cleared.');
  }
}

function populateVehicleForm() {
  if (!state.vehicleProfile) return;
  elements.vehicleNickname.value = state.vehicleProfile.nickname || '';
  elements.vehicleType.value = state.vehicleProfile.type || '';
  elements.vehiclePlate.value = state.vehicleProfile.plate || '';
}

function saveVehicleProfile(event) {
  event.preventDefault();
  const nickname = elements.vehicleNickname.value.trim();
  const type = elements.vehicleType.value;
  const plate = elements.vehiclePlate.value.trim();
  const profile = { nickname, type, plate };
  state.vehicleProfile = profile;
  localStorage.setItem(STORAGE_KEYS.vehicleProfile, JSON.stringify(profile));
  elements.vehicleUpdatedMessage.style.display = 'block';
  setTimeout(() => {
    elements.vehicleUpdatedMessage.style.display = 'none';
  }, 2500);
  if (elements.reservationModal.classList.contains('visible')) {
    elements.modalVehicleSummary.textContent = state.vehicleProfile ? `${state.vehicleProfile.nickname || 'Primary vehicle'} (${state.vehicleProfile.type}) • ${state.vehicleProfile.plate}` : 'No vehicle saved';
    if (elements.cardName.value.trim() === '' && state.vehicleProfile.nickname) {
      elements.cardName.value = state.vehicleProfile.nickname;
    }
  }
}

function applyPromoCode() {
  if (!state.pendingReservation) return;
  const code = elements.promoCodeInput.value.trim();
  if (code.toUpperCase() === 'SAVE10') {
    const discount = state.pendingReservation.total * 0.1;
    state.pendingReservation.discount = parseFloat(discount.toFixed(2));
    const newTotal = state.pendingReservation.total - state.pendingReservation.discount;
    elements.paymentTotal.textContent = `$${newTotal.toFixed(2)}`;
    elements.confirmTotal && (elements.confirmTotal.textContent = `$${newTotal.toFixed(2)}`);
    elements.promoSuccess.style.display = 'block';
  } else {
    elements.promoSuccess.style.display = 'none';
  }
}

function shareReservationLink() {
  const reservation = state.activeReservation || state.pendingReservation;
  if (!reservation) {
    showToast('No reservation available to share.');
    return;
  }
  const baseUrl = window.location.origin + window.location.pathname;
  const shareUrl = `${baseUrl}?spot=${reservation.spotId}`;
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(shareUrl).then(() => {
      showToast('Link copied to clipboard.');
    }).catch(() => {
      showToast('Unable to copy link.');
    });
  } else {
    const temp = document.createElement('textarea');
    temp.value = shareUrl;
    document.body.appendChild(temp);
    temp.select();
    try {
      document.execCommand('copy');
      showToast('Link copied to clipboard.');
    } catch (e) {
      showToast('Unable to copy link.');
    }
    document.body.removeChild(temp);
  }
}

function setupTutorial() {
  const done = localStorage.getItem(STORAGE_KEYS.tutorial);
  if (done) return;
  state.tutorialIndex = 0;
  showTutorialStep();
  elements.tutorialOverlay.classList.add('visible');
}

function showTutorialStep() {
  const step = tutorialSteps[state.tutorialIndex];
  elements.tutorialTitle.textContent = step.title;
  elements.tutorialMessage.textContent = step.message;
  elements.tutorialNext.textContent = state.tutorialIndex === tutorialSteps.length - 1 ? 'Got it' : 'Next';
}

function advanceTutorial() {
  if (state.tutorialIndex < tutorialSteps.length - 1) {
    state.tutorialIndex += 1;
    showTutorialStep();
  } else {
    completeTutorial();
  }
}

function completeTutorial() {
  elements.tutorialOverlay.classList.remove('visible');
  localStorage.setItem(STORAGE_KEYS.tutorial, 'true');
}

function clamp(value, min, max) {
  return Math.max(min, Math.min(max, value));
}

function formatDateForDisplay(dateString) {
  const [year, month, day] = dateString.split('-');
  const date = new Date(`${year}-${month}-${day}T00:00:00`);
  const options = { month: 'short', day: 'numeric', year: 'numeric' };
  return date.toLocaleDateString(undefined, options);
}

function showToast(message) {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  elements.toastContainer.appendChild(toast);
  setTimeout(() => {
    toast.remove();
  }, 3600);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>